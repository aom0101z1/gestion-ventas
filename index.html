<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ========== SECTION 1: META TAGS & TITLE ========== -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè´ Ciudad Bilingue - CRM Complete</title>
    <link rel="icon" href="data:,">

    <!-- ========== SECTION 2: CSS STYLES ========== -->
    <style>
        /* ===== RESET Y CONFIGURACI√ìN B√ÅSICA ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        /* ===== HEADER Y LAYOUT ===== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* ===== LOGIN STYLES ===== */
        .login-container {
            max-width: 400px;
            margin: 5rem auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .login-form { 
            padding: 2rem; 
        }

        /* ===== FIREBASE STATUS INDICATOR ===== */
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .firebase-status.disconnected {
            background: #ef4444;
        }
        
        .firebase-status.connecting {
            background: #f59e0b;
        }

        /* ===== FORM STYLES ===== */
        .form-group { 
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ===== BUTTON STYLES ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5a67d8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }
        .btn-firebase { background: #ff6b35; color: white; }
        .btn-firebase:hover:not(:disabled) { background: #e55a31; }

        /* ===== USER INFO & STATS ===== */
        .user-info {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: white;
            transition: all 0.3s ease;
            color: #374151;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #f3f4f6;
        }
        
        .tab-content {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* ===== COATS REPORT FIX ===== */
        #coatsReports,
        #coatsReports.tab-content,
        div#coatsReports {
            background: none !important;
            background-color: transparent !important;
            padding: 0 !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            border: none !important;
            margin: 0 !important;
        }

        #coatsReportContainer {
            width: 100%;
        }

        /* ===== AUDIT LOG FIX ===== */
        /* Only apply these styles when audit log is NOT hidden */
        #auditLogContainer.tab-content:not(.hidden) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            width: 100% !important;
            min-height: 600px !important;
            background: #f9fafb !important;
        }

        #auditLogContainer:not(.hidden) * {
            visibility: visible !important;
        }

        /* ===== REPORT TABS ===== */
        .report-tab {
            padding: 0.75rem 1.5rem;
            margin-right: 0.5rem;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6b7280;
        }

        .report-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .report-tab:hover:not(.active) {
            color: #4f46e5;
            background: #f8fafc;
        }

        .report-content {
            margin-top: 2rem;
        }

        .report-content.hidden {
            display: none;
        }

        /* ===== TABLE ===== */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .table th, .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table th {
            background: #f9fafb;
            font-weight: 600;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-nuevo { background: #fef3c7; color: #92400e; }
        .status-contactado { background: #dbeafe; color: #1e40af; }
        .status-interesado { background: #d1fae5; color: #065f46; }
        .status-convertido { background: #dcfce7; color: #166534; }
        .status-negociacion { background: #fed7aa; color: #c2410c; }
        .status-perdido { background: #fee2e2; color: #dc2626; }

        /* ===== CONVENIO STYLES ===== */
        .convenio-group {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .convenio-group.hidden {
            display: none !important;
        }

        /* ===== LOADING SPINNER ===== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { display: none !important; }
        
        /* ===== ERROR MESSAGES ===== */
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #dc2626;
        }
        
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #10b981;
        }

        /* ===== PIPELINE STYLES ===== */
        .pipeline-column {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            min-height: 300px;
        }

        .pipeline-header {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
        }

        .pipeline-body {
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .lead-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lead-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .user-info { flex-direction: column; gap: 1rem; }
            .tabs { flex-direction: column; }
        }
/* Enhanced Mobile Support */
@media (max-width: 768px) {
    .pipeline-grid {
        grid-template-columns: 1fr !important;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    .lead-card {
        padding: 0.75rem !important;
    }
    
    .tabs {
        flex-direction: column !important;
    }
    
    .tab {
        padding: 0.75rem !important;
        font-size: 0.9rem !important;
    }
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f4f6;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    transform: translate(-50%, -50%);
}

/* ===== MODAL STYLES ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalFadeIn 0.2s ease-out;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

    </style>

    <!-- Twemoji for emoji fallback on older systems (Windows 7, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
</head>

<body>
     <script>
    // Simple password protection
    if (!sessionStorage.getItem('authenticated')) {
        const password = prompt('Ingrese la contrase√±a del sistema:');
        if (password !== 'ziudad2025') {  // ‚Üê CHANGE THIS PASSWORD
            alert('Contrase√±a incorrecta');
            window.location.href = 'https://google.com';
        }
        sessionStorage.setItem('authenticated', 'true');
    }
    </script>
    
    <!-- ========== SECTION 3: FIREBASE STATUS INDICATOR ========== -->
    <div id="firebaseStatus" class="firebase-status connecting">
        <div class="loading-spinner" style="width: 12px; height: 12px; border-width: 2px;"></div>
        Conectando a Firebase...
    </div>
    
    <!-- ========== SECTION 4: SOCIAL MEDIA TAB (HIDDEN) ========== -->
    <div id="socialMedia" class="tab-content hidden">
    <h2>üí¨ Gesti√≥n de Redes Sociales</h2>
    <div id="socialMediaContainer">
        <!-- Content will be loaded by social.js -->
    </div>
</div>
    
    <!-- ========== SECTION 5: LOGIN SCREEN ========== -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>üè´ Ciudad Bilingue</h1>
                <p>Sistema CRM Completo</p>
                <div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.9;">
                    üî• Sistema completamente funcional
                </div>
            </div>
            <div class="login-form">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="username">Email:</label>
                        <input type="email" id="username" required placeholder="usuario@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label for="password">Contrase√±a:</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-firebase" style="width: 100%;" id="loginBtn">
                        üîê Ingresar con Firebase
                    </button>
                </form>
                <div id="loginError" class="error-message hidden">
                    ‚ùå Error de autenticaci√≥n
                </div>
            </div>
        </div>
    </div>

    <!-- ========== SECTION 6: MAIN APPLICATION CONTAINER ========== -->
    <div id="mainApp" class="hidden">
        
        <!-- ========== SECTION 6.1: HEADER ========== -->
        <div class="header">
            <h1>üè´ Ciudad Bilingue - CRM Completo ‚úÖ</h1>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                üî• Sistema completamente funcional y operativo
            </div>
        </div>

        <div class="container">
            <!-- ========== SECTION 6.2: USER INFO BAR ========== -->
            <div class="user-info">
                <div>
                    <strong id="currentUserName">Usuario</strong>
                    <span id="userRole" style="color: #667eea; font-size: 0.9rem;"></span>
                    <span style="background: #ff6b35; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem; margin-left: 0.5rem;">
                        üî• Firebase
                    </span>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button onclick="refreshAllData()" class="btn btn-primary" style="padding: 0.5rem 1rem;">
                        üîÑ Sync
                    </button>
                    <button onclick="handleLogout()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                        üö™ Cerrar Sesi√≥n
                    </button>
                </div>
            </div>

            <!-- ========== SECTION 6.3: STATS CARDS ========== -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" style="color: #10b981;" id="totalLeads">0</div>
                    <div>Total Leads</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">üìä Firebase</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #667eea;" id="activeLeads">0</div>
                    <div>Leads Activos</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">‚ö° Tiempo Real</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #f59e0b;" id="conversions">0</div>
                    <div>Conversiones</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">üí∞ Ventas</div>
                </div>
            </div>

            <!-- ========== SECTION 6.4: NAVIGATION TABS ========== -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('contacts')" id="contactsTab">üìû Contactos</button>
                <button class="tab" onclick="switchTab('leads')" id="leadsTab">üë• Leads</button>
                <button class="tab" onclick="switchTab('pipeline')" id="pipelineTab">üéØ Pipeline</button>
                <button class="tab" onclick="switchTab('reports')" id="reportsTab">üìä Reportes</button>
                <button class="tab" onclick="switchTab('coatsReports')" id="coatsReportsTab">üè¢ COATS</button>
                <button class="tab" onclick="switchTab('monitoring')" id="monitoringTab" style="display: none;">üëÄ Monitoreo</button>
                <button onclick="switchTab('tasks')" class="tab">üìã Tareas</button>
                <button class="tab" onclick="switchTab('auditLog')" id="auditLogTab" style="display: none;">üìã Registro</button>
                <button class="tab" onclick="switchTab('config')" id="configTab" style="display: none;">‚öôÔ∏è Config</button>
                <button class="tab" onclick="switchTab('admin')" id="adminTab" style="display: none;">üîê Admin</button>
                <button class="tab" onclick="switchTab('socialMedia')" id="socialMediaTab">üí¨ Social Media</button>
            </div>

            <!-- ========== SECTION 7: TAB CONTENT - CONTACTS ========== -->
            <div id="contacts" class="tab-content">
                <h2 id="contactsTitle">üìû Registrar Contactos del D√≠a</h2>

                <!-- Contact Type Tabs -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; justify-content: center;">
                    <button class="contact-type-tab active" onclick="switchContactType('general')" id="generalContactTab" style="
                        padding: 0.75rem 2rem;
                        border: 2px solid #667eea;
                        background: #667eea;
                        color: white;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.2s ease;
                    ">
                        üë§ General
                    </button>
                    <button class="contact-type-tab" onclick="switchContactType('company')" id="companyContactTab" style="
                        padding: 0.75rem 2rem;
                        border: 2px solid #667eea;
                        background: white;
                        color: #667eea;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.2s ease;
                    ">
                        üè¢ Empresas
                    </button>
                </div>

                <!-- GENERAL CONTACT FORM -->
                <div id="generalContactForm" style="max-width: 600px; margin: 2rem auto;">
                    <div>
                        <h3>‚ûï Nuevo Contacto Individual</h3>
                        <form onsubmit="handleAddContact(event, 'individual')">
                            <div class="form-group">
                                <label>Nombre Completo:</label>
                                <input type="text" id="contactName" required>
                            </div>
                            <div class="form-group">
                                <label>Tel√©fono:</label>
                                <input type="tel" id="contactPhone" required>
                            </div>
                            <div class="form-group">
                                <label>Email:</label>
                                <input type="email" id="contactEmail">
                            </div>
                            <div class="form-group">
                                <label>¬øC√≥mo se enter√≥?</label>
                                <select id="contactSource" required onchange="handleSourceChange()">
                                    <option value="">Seleccionar...</option>
                                    <option value="Facebook">Facebook</option>
                                    <option value="Instagram">Instagram</option>
                                    <option value="Google">Google</option>
                                    <option value="Referido">Referido</option>
                                    <option value="Volante">Volante</option>
                                    <option value="Pasando por la sede">Pasando por la sede</option>
                                    <option value="CONVENIO">Convenio</option>
                                </select>
                            </div>
                            <div class="form-group convenio-group hidden" id="convenioGroup">
                                <label>Convenio:</label>
                                <select id="contactConvenio">
                                    <option value="">Seleccionar convenio...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>¬øD√≥nde vive?</label>
                                <select id="contactLocation" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Pereira">Pereira</option>
                                    <option value="Dosquebradas">Dosquebradas</option>
                                    <option value="La Virginia">La Virginia</option>
                                    <option value="Santa Rosa">Santa Rosa</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Notas:</label>
                                <textarea id="contactNotes" rows="3" placeholder="Intereses, observaciones..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-firebase" style="width: 100%;">
                                ‚úÖ Guardar Contacto Individual
                            </button>
                        </form>
                    </div>
                </div>

                <!-- COMPANY CONTACT FORM -->
                <div id="companyContactForm" style="max-width: 700px; margin: 2rem auto; display: none;">
                    <div>
                        <h3>üè¢ Nuevo Contacto Empresarial</h3>
                        <form onsubmit="handleAddContact(event, 'company')">

                            <!-- Company Information Section -->
                            <fieldset style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <legend style="font-weight: 600; color: #667eea; padding: 0 0.5rem;">üìã Informaci√≥n de la Empresa</legend>

                                <div class="form-group">
                                    <label>Nombre de la Empresa/Instituci√≥n:</label>
                                    <input type="text" id="companyName" required>
                                </div>

                                <div class="form-group">
                                    <label>Tipo de Organizaci√≥n:</label>
                                    <select id="companyType" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="Empresa Privada">Empresa Privada</option>
                                        <option value="Colegio">Colegio</option>
                                        <option value="Universidad">Universidad</option>
                                        <option value="ONG">ONG</option>
                                        <option value="Gobierno">Gobierno</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Sector/Industria:</label>
                                    <input type="text" id="companySector" placeholder="Ej: Tecnolog√≠a, Educaci√≥n, Salud, Manufactura...">
                                </div>
                            </fieldset>

                            <!-- Contact Person Section -->
                            <fieldset style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <legend style="font-weight: 600; color: #667eea; padding: 0 0.5rem;">üë§ Informaci√≥n del Contacto</legend>

                                <div class="form-group">
                                    <label>Nombre del Contacto:</label>
                                    <input type="text" id="companyContactName" required>
                                </div>

                                <div class="form-group">
                                    <label>Cargo/Posici√≥n:</label>
                                    <select id="companyContactPosition" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="Director RRHH">Director de Recursos Humanos</option>
                                        <option value="Rector">Rector</option>
                                        <option value="Coordinador">Coordinador Acad√©mico</option>
                                        <option value="Gerente">Gerente General</option>
                                        <option value="Director Capacitaci√≥n">Director de Capacitaci√≥n</option>
                                        <option value="Responsable Formaci√≥n">Responsable de Formaci√≥n</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Tel√©fono Directo:</label>
                                        <input type="tel" id="companyContactPhone" required>
                                    </div>

                                    <div class="form-group">
                                        <label>Tel√©fono Empresa (opcional):</label>
                                        <input type="tel" id="companyPhone">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Email Corporativo:</label>
                                    <input type="email" id="companyContactEmail" required>
                                </div>
                            </fieldset>

                            <!-- Business Details Section -->
                            <fieldset style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <legend style="font-weight: 600; color: #667eea; padding: 0 0.5rem;">üíº Detalles del Negocio</legend>

                                <div class="form-group">
                                    <label>¬øC√≥mo se enter√≥?</label>
                                    <select id="companySource" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="Referido">Referido</option>
                                        <option value="B√∫squeda en Google">B√∫squeda en Google</option>
                                        <option value="LinkedIn">LinkedIn</option>
                                        <option value="Llamada Directa">Llamada Directa</option>
                                        <option value="Email Comercial">Email Comercial</option>
                                        <option value="Evento/Feria">Evento/Feria</option>
                                        <option value="Cliente Anterior">Cliente Anterior</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>N√∫mero Estimado de Personas Interesadas:</label>
                                    <input type="number" id="companyEstimatedLeads" min="1" placeholder="Ej: 10, 25, 50...">
                                </div>

                                <div class="form-group">
                                    <label>Tipo de Servicio que Buscan:</label>
                                    <select id="companyServiceType" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="Clases Grupales">Clases Grupales</option>
                                        <option value="In-Company">In-Company (en sus instalaciones)</option>
                                        <option value="Convenio Empresarial">Convenio Empresarial</option>
                                        <option value="Capacitaci√≥n Certificada">Capacitaci√≥n Certificada</option>
                                        <option value="Programa Personalizado">Programa Personalizado</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Ubicaci√≥n:</label>
                                    <select id="companyLocation" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="Pereira">Pereira</option>
                                        <option value="Dosquebradas">Dosquebradas</option>
                                        <option value="La Virginia">La Virginia</option>
                                        <option value="Santa Rosa">Santa Rosa</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Notas:</label>
                                    <textarea id="companyNotes" rows="3" placeholder="Necesidades espec√≠ficas, presupuesto aproximado, timeline..."></textarea>
                                </div>
                            </fieldset>

                            <button type="submit" class="btn btn-firebase" style="width: 100%;">
                                ‚úÖ Guardar Contacto Empresarial
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ========== SECTION 8: TAB CONTENT - LEADS ========== -->
            <div id="leads" class="tab-content hidden">
                <h2 id="leadsTitle">üë• Gesti√≥n de Leads</h2>

                <!-- Lead Type Tabs -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; justify-content: center;">
                    <button class="lead-type-tab active" onclick="switchLeadType('general')" id="generalLeadTab" style="
                        padding: 0.75rem 2rem;
                        border: 2px solid #667eea;
                        background: #667eea;
                        color: white;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.2s ease;
                    ">
                        üë§ General
                    </button>
                    <button class="lead-type-tab" onclick="switchLeadType('company')" id="companyLeadTab" style="
                        padding: 0.75rem 2rem;
                        border: 2px solid #667eea;
                        background: white;
                        color: #667eea;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.2s ease;
                    ">
                        üè¢ Empresas
                    </button>
                </div>

                <!-- GENERAL LEADS VIEW -->
                <div id="generalLeadsView">
                    <div style="margin-bottom: 1rem;">
                        <button onclick="refreshAllData()" class="btn btn-primary" style="margin-right: 1rem;">üîÑ Sync Firebase</button>

                        <div id="leadsFilters" style="display: none; margin-top: 1rem;">
                            <select id="salespersonFilter" onchange="updateLeadsTable('individual')" style="padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; margin-right: 0.5rem;">
                                <option value="">Todos los vendedores</option>
                            </select>
                            <select id="statusFilter" onchange="updateLeadsTable('individual')" style="padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc;">
                                <option value="">Todos los estados</option>
                                <option value="Nuevo">Nuevo</option>
                                <option value="Contactado">Contactado</option>
                                <option value="Interesado">Interesado</option>
                                <option value="Negociaci√≥n">Negociaci√≥n</option>
                                <option value="Convertido">Convertido</option>
                                <option value="Perdido">Perdido</option>
                            </select>
                        </div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr id="leadsTableHeader">
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Fuente</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #666; padding: 2rem;">
                                    <div class="loading-spinner"></div><br>
                                    Cargando leads individuales...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- COMPANY LEADS VIEW -->
                <div id="companyLeadsView" style="display: none;">
                    <div style="margin-bottom: 1rem;">
                        <button onclick="refreshAllData()" class="btn btn-primary" style="margin-right: 1rem;">üîÑ Sync Firebase</button>
                    </div>

                    <table class="table">
                        <thead>
                            <tr id="companyLeadsTableHeader">
                                <th>Empresa</th>
                                <th>Tipo</th>
                                <th>Contacto</th>
                                <th>Cargo</th>
                                <th>Tel√©fono</th>
                                <th>Est. Leads</th>
                                <th>Servicio</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="companyLeadsTable">
                            <tr>
                                <td colspan="9" style="text-align: center; color: #666; padding: 2rem;">
                                    <div class="loading-spinner"></div><br>
                                    Cargando contactos empresariales...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ========== SECTION 9: TAB CONTENT - PIPELINE ========== -->
            <div id="pipeline" class="tab-content hidden">
                <h2>üéØ Pipeline de Ventas</h2>
                <div style="margin-bottom: 1rem;">
                    <button onclick="refreshPipeline()" class="btn btn-primary">üîÑ Actualizar Pipeline</button>
                </div>
                <div id="pipelineContainer">
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div class="loading-spinner"></div><br>
                        Cargando pipeline desde Firebase...
                    </div>
                </div>
            </div>

            <!-- ========== SECTION 10: TAB CONTENT - REPORTS ========== -->
            <div id="reports" class="tab-content hidden">
                <h2 id="reportsTitle">üìä Dashboard de Reportes</h2>
                
                <!-- Period Selector -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center;">
                    <label><strong>Per√≠odo:</strong></label>
                    <select id="reportsPeriod" onchange="updateReportsPeriod()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="daily">Diario</option>
                        <option value="weekly">Semanal</option>
                        <option value="monthly" selected>Mensual</option>
                        <option value="semester">Semestral</option>
                        <option value="yearly">Anual</option>
                        <option value="custom">Personalizado</option>
                    </select>
                    
                    <div id="customDateRange" style="display: none;">
                        <input type="date" id="startDate" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
                        <span>a</span>
                        <input type="date" id="endDate" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
                    </div>
                    
                    <button onclick="refreshReports()" class="btn btn-primary">üîÑ Actualizar</button>
                    <button onclick="exportReports()" class="btn btn-success">üì• Exportar</button>
                </div>

                <!-- Key Metrics Cards -->
                <div id="keyMetrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="metric-card" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: #28a745;">üí∞</div>
                        <div id="totalIncome" style="font-size: 1.5rem; font-weight: bold; color: #333;">$0</div>
                        <div style="color: #666;">Ingresos Totales</div>
                    </div>
                    
                    <div class="metric-card" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: #007bff;">üë•</div>
                        <div id="activeStudents" style="font-size: 1.5rem; font-weight: bold; color: #333;">0</div>
                        <div style="color: #666;">Estudiantes Activos</div>
                    </div>
                    
                    <div class="metric-card" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: #17a2b8;">üìà</div>
                        <div id="newEnrollments" style="font-size: 1.5rem; font-weight: bold; color: #333;">0</div>
                        <div style="color: #666;">Nuevas Matr√≠culas</div>
                    </div>
                    
                    <div class="metric-card" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: #ffc107;">‚è∞</div>
                        <div id="pendingPayments" style="font-size: 1.5rem; font-weight: bold; color: #333;">$0</div>
                        <div style="color: #666;">Pagos Pendientes</div>
                    </div>
                </div>

                <!-- Report Tabs -->
                <div style="border-bottom: 1px solid #ccc; margin-bottom: 2rem;">
                    <button class="report-tab active" onclick="switchReportTab('financial')" id="financialReportTab">üí∞ Financiero</button>
                    <button class="report-tab" onclick="switchReportTab('students')" id="studentsReportTab">üë• Estudiantes</button>
                    <button class="report-tab" onclick="switchReportTab('sales')" id="salesReportTab">üéØ Ventas</button>
                    <button class="report-tab" onclick="switchReportTab('invoices')" id="invoicesReportTab">üìÑ Facturas</button>
                </div>

                <!-- Financial Reports -->
                <div id="financialReports" class="report-content">
                    <h3>üí∞ Reporte Financiero</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h4>Ingresos Diarios</h4>
                            <canvas id="dailyIncomeChart" width="400" height="200"></canvas>
                        </div>
                        <div>
                            <h4>M√©todos de Pago</h4>
                            <canvas id="paymentMethodsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div id="financialSummary" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                        <h4>Resumen Financiero</h4>
                        <div id="financialDetails">Cargando datos financieros...</div>
                    </div>
                </div>

                <!-- Student Reports -->
                <div id="studentReports" class="report-content hidden">
                    <h3>üë• Reporte de Estudiantes</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h4>Tendencia de Matr√≠culas</h4>
                            <canvas id="enrollmentTrendChart" width="400" height="200"></canvas>
                        </div>
                        <div>
                            <h4>Cursos Populares</h4>
                            <canvas id="coursePopularityChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div id="studentSummary" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                        <h4>Resumen de Estudiantes</h4>
                        <div id="studentDetails">Cargando datos de estudiantes...</div>
                    </div>
                </div>

                <!-- Sales Reports -->
                <div id="salesReports" class="report-content hidden">
                    <h3>üéØ Reporte de Ventas</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h4>Leads Diarios</h4>
                            <canvas id="dailyLeadsChart" width="400" height="200"></canvas>
                        </div>
                        <div>
                            <h4>Fuentes de Leads</h4>
                            <canvas id="leadSourcesChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div id="salesSummary" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                        <h4>Resumen de Ventas</h4>
                        <div id="salesDetails">Cargando datos de ventas...</div>
                    </div>
                </div>

                <!-- Invoices Reports -->
                <div id="invoicesReports" class="report-content hidden">
                    <h3>üìÑ Historial de Facturas</h3>

                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                        <input type="text" id="invoiceSearchInput" placeholder="Buscar por estudiante o # factura..."
                            style="padding: 0.5rem 1rem; border: 1px solid #ccc; border-radius: 4px; flex: 1; max-width: 300px;"
                            onkeyup="filterInvoicesTable()">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="showVoidedOnly" onchange="filterInvoicesTable()">
                            Solo anuladas
                        </label>
                        <button onclick="exportInvoicesData()" class="btn btn-success">üì• Exportar CSV</button>
                    </div>

                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; max-height: 600px; overflow-y: auto;">
                        <table id="invoicesReportTable" style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: #f8f9fa;">
                                <tr style="border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 0.75rem; text-align: left;">Factura #</th>
                                    <th style="padding: 0.75rem; text-align: left;">Fecha</th>
                                    <th style="padding: 0.75rem; text-align: left;">Estudiante</th>
                                    <th style="padding: 0.75rem; text-align: right;">Monto</th>
                                    <th style="padding: 0.75rem; text-align: center;">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesReportBody">
                                <tr><td colspan="5" style="text-align: center; padding: 2rem;">Cargando facturas...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="invoicesSummary" style="margin-top: 1rem; display: flex; gap: 2rem; justify-content: center;">
                        <div style="background: #d4edda; padding: 1rem; border-radius: 8px; text-align: center;">
                            <strong id="totalInvoicesCount">0</strong>
                            <div style="font-size: 0.85rem; color: #155724;">Total Facturas</div>
                        </div>
                        <div style="background: #f8d7da; padding: 1rem; border-radius: 8px; text-align: center;">
                            <strong id="voidedInvoicesCount">0</strong>
                            <div style="font-size: 0.85rem; color: #721c24;">Anuladas</div>
                        </div>
                        <div style="background: #cce5ff; padding: 1rem; border-radius: 8px; text-align: center;">
                            <strong id="totalInvoicesAmount">$0</strong>
                            <div style="font-size: 0.85rem; color: #004085;">Monto Total (Activas)</div>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee; text-align: center;">
                    <h4>Exportar Datos</h4>
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                        <button onclick="exportFinancialData()" class="btn btn-success">üìä Datos Financieros</button>
                        <button onclick="exportStudentData()" class="btn btn-success">üë• Datos Estudiantes</button>
                        <button onclick="exportSalesData()" class="btn btn-success">üéØ Datos Ventas</button>
                        <button onclick="exportTodayContacts()" class="btn btn-success">üìû Contactos de Hoy</button>
                    </div>
                </div>
            </div>

            <!-- ========== SECTION 11: TAB CONTENT - MONITORING ========== -->
            <div id="monitoring" class="tab-content hidden">
                <h2>üëÄ Monitoreo del Equipo</h2>
                <div style="margin-bottom: 1rem;">
                    <button onclick="refreshAllData()" class="btn btn-primary">üîÑ Actualizar Monitoreo</button>
                </div>
                
                <div id="teamActivityOverview" style="margin-bottom: 2rem;">
                    <div class="loading-spinner"></div> Cargando vista general...
                </div>
                
                <div id="individualSalespeopleActivity" style="margin-bottom: 2rem;">
                    <h3>üë• Actividad Individual</h3>
                    <div class="loading-spinner"></div> Cargando actividad individual...
                </div>
                
                <div id="recentTeamActivity">
                    <h3>üïí Actividad Reciente del Equipo</h3>
                    <div class="loading-spinner"></div> Cargando actividad reciente...
                </div>
            </div>

            <!-- ========== SECTION 12: TAB CONTENT - TASKS ========== -->
            <div id="tasks" class="tab-content hidden">
                <div id="tasksContainer"></div>
            </div>

            <!-- ========== SECTION 12.1: TAB CONTENT - EMPLOYEES (DIRECTOR ONLY) ========== -->
            <div id="employees" class="tab-content hidden">
                <div id="employeesContainer"></div>
            </div>

            <!-- ========== SECTION 13: TAB CONTENT - CONFIG ========== -->
            <div id="config" class="tab-content hidden">
                <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>
                
                <div id="directorConfig" class="hidden">
                    <!-- Section 13.1: System Tools -->
                    <div style="background: #dbeafe; padding: 2rem; border-radius: 10px; border-left: 4px solid #3b82f6; margin-bottom: 2rem;">
                        <h3>üîÑ Herramientas de Sistema</h3>
                        <p style="margin: 1rem 0; color: #1e40af;">Herramientas para administrar el sistema.</p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button onclick="testConveniosSystem()" class="btn btn-firebase">üß™ Test Convenios</button>
                            <button onclick="testTabSystem()" class="btn btn-success">üß™ Test Tabs</button>
                            <button onclick="refreshAllData()" class="btn btn-primary">üîÑ Refresh Data</button>
                        </div>
                    </div>
                    
                    <!-- Section 13.2: Convenios -->
                    <div style="background: #f0f9ff; padding: 2rem; border-radius: 10px; border-left: 4px solid #0284c7; margin-bottom: 2rem;">
                        <h3>üë• Gesti√≥n de Convenios</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                            <div>
                                <div class="form-group">
                                    <label>Nuevo Convenio:</label>
                                    <input type="text" id="newConvenio" placeholder="Nombre del convenio">
                                </div>
                                <button onclick="addConvenio()" class="btn btn-success" style="width: 100%;">‚ûï Agregar Convenio</button>
                            </div>
                            <div>
                                <h4>Convenios Actuales:</h4>
                                <div id="conveniosList" style="max-height: 300px; overflow-y: auto; margin-top: 1rem;">
                                    <div class="loading-spinner"></div> Cargando convenios...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 13.3: User Management -->
                    <div style="background: #e0f2fe; padding: 2rem; border-radius: 10px; border-left: 4px solid #0284c7; margin-bottom: 2rem;">
                        <h3>üë• Gesti√≥n de Usuarios</h3>
                        <p style="margin: 1rem 0; color: #075985;">Crear y gestionar cuentas de usuarios del sistema.</p>
                        
                        <!-- Add User Form -->
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4>‚ûï Crear Nuevo Usuario</h4>
                            <form onsubmit="handleCreateUser(event)" style="margin-top: 1rem;">
                                <div class="form-group">
                                    <label>Nombre Completo:</label>
                                    <input type="text" id="newUserName" required placeholder="Ej: Juan P√©rez">
                                </div>
                                <div class="form-group">
                                    <label>Email:</label>
                                    <input type="email" id="newUserEmail" required placeholder="usuario@ejemplo.com">
                                </div>
                                <div class="form-group">
                                    <label>Contrase√±a:</label>
                                    <input type="password" id="newUserPassword" required minlength="6" placeholder="M√≠nimo 6 caracteres">
                                </div>
                                <div class="form-group">
                                    <label>Rol:</label>
                                    <select id="newUserRole" required>
                                        <option value="">Seleccionar rol...</option>
                                        <option value="vendedor">Vendedor</option>
                                        <option value="director">Director</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    üë§ Crear Usuario
                                </button>
                            </form>
                        </div>
                        
                        <!-- Current Users List -->
                        <div style="background: white; padding: 1.5rem; border-radius: 8px;">
                            <h4>üìã Usuarios Actuales</h4>
                            <div id="usersList" style="margin-top: 1rem;">
                                <div class="loading-spinner"></div> Cargando usuarios...
                            </div>
                        </div>
                    </div>
                    
                </div> <!-- End of directorConfig -->
            </div> <!-- End of config tab -->

            <!-- ========== SECTION 14: TAB CONTENT - ADMIN (PLACEHOLDER) ========== -->
            <div id="adminContainer" class="tab-content" style="display: none;">
                <!-- El contenido se carga din√°micamente desde admin-center.js -->
            </div>

            <!-- ========== SECTION 15: TAB CONTENT - AUDIT LOG ========== -->
            <div id="auditLogContainer" class="tab-content" style="display: none;">
                <!-- El contenido se carga din√°micamente desde auditlog.js -->
            </div>

            <!-- ========== SECTION 15.1: TAB CONTENT - GRUPOS 2.0 (ADMIN ONLY) ========== -->
            <div id="grupos2Container" class="tab-content hidden">
                <!-- El contenido se carga din√°micamente desde grupos2.js -->
            </div>

            <!-- ========== SECTION 15.2: TAB CONTENT - COATS REPORTS ========== -->
            <div id="coatsReports" class="tab-content hidden">
                <div id="coatsReportContainer"></div>
            </div>

        </div> <!-- End of container -->
    </div> <!-- End of mainApp -->

    <!-- ========== SECTION 15: FIREBASE SDK INITIALIZATION ========== -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, update, remove, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  
    //    <!-- Store Firebase modules globally for access from other scripts -->

window.firebaseModules = {
    database: { ref, set, get, push, update, remove, onValue, off },
    auth: { sendPasswordResetEmail }
};
        const firebaseConfig = {
            apiKey: "AIzaSyCuq1z8eTo9rufdEDXQFfvoxOkce-kBWOY",
            authDomain: "ciudad-bilingue-crm.firebaseapp.com",
            databaseURL: "https://ciudad-bilingue-crm-default-rtdb.firebaseio.com",
            projectId: "ciudad-bilingue-crm",
            storageBucket: "ciudad-bilingue-crm.firebasestorage.app",
            messagingSenderId: "690594486040",
            appId: "1:690594486040:web:e8fffcffcee68a4d94f06d"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        window.firebaseApp = app;
        window.firebaseDb = database;
        window.firebaseAuth = auth;

        const statusEl = document.getElementById('firebaseStatus');
        statusEl.className = 'firebase-status';
        statusEl.innerHTML = 'üî• Firebase Conectado';

        console.log('‚úÖ Firebase initialized successfully');

        // ========== SECTION 15.1: SIMPLE FIREBASE MANAGER CLASS ==========
        class SimpleFirebaseManager {
            constructor() {
                this.database = database;
                this.auth = auth;
                this.currentUser = null;
                this.observers = [];
                
                console.log('üî• SimpleFirebaseManager initialized');
                
                onAuthStateChanged(this.auth, (user) => {
                    if (user) {
                        this.currentUser = user;
                        console.log('‚úÖ Firebase user authenticated:', user.email);
                    } else {
                        this.currentUser = null;
                        console.log('‚ÑπÔ∏è No Firebase user authenticated');
                    }
                });
            }

            async login(email, password) {
                return await signInWithEmailAndPassword(this.auth, email, password);
            }

            async createUser(email, password, profile) {
                const userCredential = await createUserWithEmailAndPassword(this.auth, email, password);
                const user = userCredential.user;
                
                await set(ref(this.database, `users/${user.uid}/profile`), {
                    name: profile.name,
                    email: email,
                    role: profile.role,
                    createdAt: new Date().toISOString()
                });
                
                return user;
            }

            async logout() {
                return await signOut(this.auth);
            }

            async loadUserProfile() {
                if (!this.currentUser) return null;
                const snapshot = await get(ref(this.database, `users/${this.currentUser.uid}/profile`));
                return snapshot.exists() ? snapshot.val() : null;
            }

            async getAllUsers() {
                const snapshot = await get(ref(this.database, 'users'));
                const users = {};
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const userId = childSnapshot.key;
                        const userData = childSnapshot.val();
                        if (userData.profile) {
                            users[userId] = userData.profile;
                        }
                    });
                }
                return users;
            }

            async addContact(contactData) {
                const contactRef = push(ref(this.database, 'contacts'));
                const contact = {
                    id: contactRef.key,
                    ...contactData,
                    salespersonId: this.currentUser.uid,
                    salespersonEmail: this.currentUser.email,
                    createdAt: new Date().toISOString()
                };
                await set(contactRef, contact);
                return contact;
            }

            async getAllContacts() {
                const snapshot = await get(ref(this.database, 'contacts'));
                const contacts = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        contacts.push(childSnapshot.val());
                    });
                }
                return contacts;
            }

            async getFilteredContacts() {
                const userProfile = await this.loadUserProfile();
                const allContacts = await this.getAllContacts();

                // Changed: All users can now see all contacts/leads
                return allContacts;
            }

            async updateContact(contactId, updates) {
                await update(ref(this.database, `contacts/${contactId}`), {
                    ...updates,
                    updatedAt: new Date().toISOString()
                });
            }

           // ========== SECTION 15.2: DELETE CONTACT METHOD ==========
async deleteContact(contactId) {
    if (!this.currentUser) throw new Error('User not authenticated');
    
    try {
        // Delete from Firebase
        await remove(ref(this.database, `contacts/${contactId}`));
        console.log('‚úÖ Contact deleted from Firebase:', contactId);
        
        // Notify any observers
        this.observers.forEach(callback => callback());
        
        return true;
    } catch (error) {
        console.error('‚ùå Error deleting contact:', error);
        throw error;
    }
}

            async getConvenios() {
                const snapshot = await get(ref(this.database, 'system/convenios'));
                return snapshot.exists() ? snapshot.val() : [];
            }

            async updateConvenios(convenios) {
                await set(ref(this.database, 'system/convenios'), convenios);
            }

            addObserver(callback) {
                this.observers.push(callback);
            }
        }

        window.FirebaseData = new SimpleFirebaseManager();
        window.dispatchEvent(new Event('firebaseReady'));

        // ========== SECTION 15.3: AUTO-LOGIN FROM SAVED SESSION ==========
onAuthStateChanged(auth, async (user) => {
    console.log('üîê Auth state changed:', user ? user.email : 'No user');
    
    if (user && !window.isInitialized) {
        try {
            console.log('üîÑ Restoring user session for:', user.email);
            
            // Wait a bit for everything to load
            setTimeout(async () => {
                // Check if login screen is visible
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');
                
                if (loginScreen && !loginScreen.classList.contains('hidden')) {
                    console.log('‚úÖ Auto-login from saved session');
                    
                    // Set current user
                    window.currentUser = user;
                    
                    // Load user profile
                    const profile = await window.FirebaseData.loadUserProfile();
                    
                    if (profile) {
                        window.userRole = profile.role;
                        
                        // Hide login, show app
                        loginScreen.classList.add('hidden');
                        mainApp.classList.remove('hidden');
                        
                        // Initialize app
                        await initializeMainApplication();
                        
                        console.log('‚úÖ Session restored successfully');
                    }
                }
            }, 1000);
            
        } catch (error) {
            console.error('‚ùå Error restoring session:', error);
        }
    }
});
    </script>

    <!-- ========== SECTION 16: MAIN APPLICATION JAVASCRIPT ========== -->
    <script>
        // ========== SECTION 16.1: GLOBAL VARIABLES ==========
        let currentUser = null;
        let userRole = null;
        let isInitialized = false;
        let cachedConvenios = [];

        // ========== SECTION 16.2: LOGIN HANDLER ==========
        async function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }
            
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.innerHTML;
            
            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<div class="loading-spinner" style="width: 12px; height: 12px; display: inline-block; margin-right: 0.5rem;"></div>Conectando...';
                
                const email = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                if (!email || !password) {
                    throw new Error('Email y contrase√±a son requeridos');
                }
                
                console.log('üîê Attempting Firebase login for:', email);
                
                const userCredential = await window.FirebaseData.login(email, password);
                console.log('‚úÖ Firebase login successful');
                
                currentUser = userCredential.user;
                
                const profile = await window.FirebaseData.loadUserProfile();
                if (!profile) {
                    throw new Error('User profile not found. Contact administrator.');
                }

                window.userRole = profile.role;
                userRole = profile.role;
                console.log('üë§ User role loaded:', userRole);
                
                document.getElementById('loginError').classList.add('hidden');
                
                await initializeMainApplication();
                
                alert(`‚úÖ ¬°Bienvenido ${profile.name}!\nüî• Sistema completamente funcional\nüëë Rol: ${profile.role}`);
                
            } catch (error) {
                console.error('‚ùå Login failed:', error);
                
                let errorMessage = 'Error de autenticaci√≥n';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado. Contacta al administrador.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contrase√±a incorrecta.';
                } else {
                    errorMessage = error.message;
                }
                
                const errorEl = document.getElementById('loginError');
                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = originalText;
            }
        }

        // ========== SECTION 16.3: MAIN APPLICATION INITIALIZATION ==========
        async function initializeMainApplication() {
            try {
                console.log('üöÄ Initializing main application');
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                const profile = await window.FirebaseData.loadUserProfile();

                updateUserInterface(profile);
                configureRoleBasedAccess(profile.role);

                // Refresh school buttons with correct role
                if (typeof addSchoolButtons === 'function') {
                    console.log('üîÑ Refreshing school buttons with role:', profile.role);
                    addSchoolButtons();
                }

                await loadInitialData();
                
                isInitialized = true;
                console.log('‚úÖ Application initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Error initializing main application:', error);
                alert('Error inicializando la aplicaci√≥n');
            }
        }

        // ========== SECTION 16.4: UI UPDATE FUNCTIONS ==========
        function updateUserInterface(profile) {
            console.log('üé® Updating user interface');
            
            const userNameEl = document.getElementById('currentUserName');
            if (userNameEl) {
                userNameEl.textContent = `Admin: ${profile.name || 'Usuario'}`;
            }
            
            const userRoleEl = document.getElementById('userRole');
            if (userRoleEl) {
                const roleEmoji = profile.role === 'director' ? 'üëë' : 'üë§';
                userRoleEl.textContent = `${roleEmoji} ${profile.role.charAt(0).toUpperCase() + profile.role.slice(1)}`;
            }
            
            const titleMappings = {
                director: {
                    'contactsTitle': 'üìû Contactos del Equipo',
                    'leadsTitle': 'üë• Gesti√≥n de Leads del Equipo',
                    'reportsTitle': 'üìä Reportes Ejecutivos'
                },
                vendedor: {
                    'contactsTitle': 'üìû Mis Contactos del D√≠a',
                    'leadsTitle': 'üë• Mis Leads',
                    'reportsTitle': 'üìä Mis Reportes'
                }
            };
            
        const titles = titleMappings[profile.role] || titleMappings.vendedor;
    Object.keys(titles).forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = titles[elementId];
        }
    });
}

        // ========== SECTION 16.5: ROLE-BASED ACCESS CONFIGURATION ==========
        function configureRoleBasedAccess(role) {
            console.log('üîê Configuring role-based access');
            
            const monitoringTab = document.getElementById('monitoringTab');
            const configTab = document.getElementById('configTab');
            const adminTab = document.getElementById('adminTab');
            const directorConfig = document.getElementById('directorConfig');
            const leadsFilters = document.getElementById('leadsFilters');
            
            if (role === 'director' || role === 'admin') {
                if (monitoringTab) monitoringTab.style.display = 'block';
                if (configTab) configTab.style.display = 'block';
                if (adminTab) adminTab.style.display = 'block';
                const auditLogTab = document.getElementById('auditLogTab');
                if (auditLogTab) auditLogTab.style.display = 'block';
                if (directorConfig) directorConfig.classList.remove('hidden');
                if (leadsFilters) leadsFilters.style.display = 'flex';

                const header = document.getElementById('leadsTableHeader');
                if (header) {
                    header.innerHTML = `
                        <th>Nombre</th>
                        <th>Tel√©fono</th>
                        <th>Fuente</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th>Vendedor</th>
                        <th>Acciones</th>
                    `;
                }
            } else {
                if (monitoringTab) monitoringTab.style.display = 'none';
                if (configTab) configTab.style.display = 'none';
                if (adminTab) adminTab.style.display = 'none';
                const auditLogTab = document.getElementById('auditLogTab');
                if (auditLogTab) auditLogTab.style.display = 'none';
                if (directorConfig) directorConfig.classList.add('hidden');
                if (leadsFilters) leadsFilters.style.display = 'none';
            }
        }

        // ========== SECTION 16.6: INITIAL DATA LOADING ==========
        async function loadInitialData() {
            try {
                console.log('üìä Loading initial data');
                
                await loadConvenios();
                await updateStats();
                await updateLeadsTable();
                
                console.log('‚úÖ Initial data loaded');
                
            } catch (error) {
                console.error('‚ùå Error loading initial data:', error);
            }
        }

        // ========== SECTION 16.7: CONVENIOS MANAGEMENT ==========
        async function loadConvenios() {
            try {
                console.log('ü§ù Loading convenios');
                
                if (!window.FirebaseData) {
                    console.log('‚ö†Ô∏è Firebase not ready');
                    return;
                }
                
                const convenios = await window.FirebaseData.getConvenios();
                console.log('üìã Loaded convenios:', convenios);
                
                cachedConvenios = convenios || [];
                
                const profile = await window.FirebaseData.loadUserProfile();
                if (profile && profile.role === 'director') {
                    await updateConveniosList();
                }
                
            } catch (error) {
                console.error('‚ùå Error loading convenios:', error);
                cachedConvenios = [];
            }
        }

        // ========== SECTION 16.8: CONTACT FORM HANDLERS ==========
        async function handleSourceChange() {
            console.log('üîÑ Source changed');
            
            const sourceSelect = document.getElementById('contactSource');
            const convenioGroup = document.getElementById('convenioGroup');
            const convenioSelect = document.getElementById('contactConvenio');
            
            if (!sourceSelect || !convenioGroup || !convenioSelect) {
                console.error('‚ùå Required elements not found');
                return;
            }
            
            console.log('üîç Source value:', sourceSelect.value);
            
            if (sourceSelect.value === 'CONVENIO') {
                console.log('‚úÖ Showing convenio dropdown');
                
                // Show convenio group
                convenioGroup.classList.remove('hidden');
                convenioSelect.required = true;
                
                // Show loading state
                convenioSelect.innerHTML = '<option value="">Cargando convenios...</option>';
                
                try {
                    // Load convenios from Firebase
                    let convenios = cachedConvenios;
                    if (!convenios || convenios.length === 0) {
                        convenios = await window.FirebaseData.getConvenios();
                        cachedConvenios = convenios || [];
                    }
                    
                    console.log('üìã Loaded convenios for dropdown:', convenios);
                    
                    // Populate dropdown
                    if (convenios && convenios.length > 0) {
                        convenioSelect.innerHTML = '<option value="">Seleccionar convenio...</option>' +
                            convenios.map(conv => `<option value="${conv}">${conv}</option>`).join('');
                        console.log('‚úÖ Convenio dropdown populated');
                    } else {
                        convenioSelect.innerHTML = '<option value="">No hay convenios configurados</option>';
                        alert('‚ö†Ô∏è No hay convenios configurados. Contacta al administrador.');
                    }
                } catch (error) {
                    console.error('‚ùå Error loading convenios:', error);
                    convenioSelect.innerHTML = '<option value="">Error cargando convenios</option>';
                    alert('‚ùå Error al cargar convenios');
                }
            } else {
                console.log('‚ùå Hiding convenio dropdown');
                convenioGroup.classList.add('hidden');
                convenioSelect.required = false;
                convenioSelect.value = '';
            }
        }

        async function handleAddContact(event, contactType = 'individual') {
            event.preventDefault();

            if (!window.FirebaseData || !window.FirebaseData.currentUser) {
                alert('‚ùå Firebase no disponible o usuario no autenticado. Recarga la p√°gina.');
                return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading-spinner" style="width: 12px; height: 12px; display: inline-block; margin-right: 0.5rem;"></div>Guardando...';

            try {
                let contact;

                if (contactType === 'company') {
                    // COMPANY CONTACT
                    contact = {
                        contactType: 'company',
                        companyName: document.getElementById('companyName').value.trim(),
                        companyType: document.getElementById('companyType').value,
                        sector: document.getElementById('companySector').value.trim(),
                        contactName: document.getElementById('companyContactName').value.trim(),
                        contactPosition: document.getElementById('companyContactPosition').value,
                        phone: document.getElementById('companyContactPhone').value.trim(),
                        email: document.getElementById('companyContactEmail').value.trim(),
                        companyPhone: document.getElementById('companyPhone').value.trim(),
                        source: document.getElementById('companySource').value,
                        estimatedLeads: parseInt(document.getElementById('companyEstimatedLeads').value) || 0,
                        serviceType: document.getElementById('companyServiceType').value,
                        location: document.getElementById('companyLocation').value,
                        notes: document.getElementById('companyNotes').value.trim(),
                        date: new Date().toISOString().split('T')[0],
                        time: new Date().toLocaleTimeString(),
                        status: 'Empresa'  // Company contacts don't use pipeline
                    };

                    // Validate required fields
                    if (!contact.companyName || !contact.companyType || !contact.contactName ||
                        !contact.contactPosition || !contact.phone || !contact.email ||
                        !contact.source || !contact.serviceType || !contact.location) {
                        alert('‚ö†Ô∏è Completa todos los campos obligatorios');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }

                } else {
                    // INDIVIDUAL CONTACT
                    let source = document.getElementById('contactSource').value;
                    if (source === 'CONVENIO') {
                        const convenio = document.getElementById('contactConvenio').value;
                        if (!convenio) {
                            alert('‚ö†Ô∏è Selecciona un convenio');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                            return;
                        }
                        source = `CONVENIO: ${convenio}`;
                    }

                    contact = {
                        contactType: 'individual',
                        name: document.getElementById('contactName').value.trim(),
                        phone: document.getElementById('contactPhone').value.trim(),
                        email: document.getElementById('contactEmail').value.trim(),
                        source: source,
                        location: document.getElementById('contactLocation').value,
                        notes: document.getElementById('contactNotes').value.trim(),
                        date: new Date().toISOString().split('T')[0],
                        time: new Date().toLocaleTimeString(),
                        status: 'Nuevo'  // Individual contacts use pipeline
                    };

                    if (!contact.name || !contact.phone || !contact.source || !contact.location) {
                        alert('‚ö†Ô∏è Completa todos los campos obligatorios');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                }

                console.log('üì§ Saving contact to Firebase:', contact);

                const savedContact = await window.FirebaseData.addContact(contact);
                console.log('‚úÖ Contact saved to Firebase:', savedContact);

                // Clear form
                event.target.reset();
                if (contactType === 'individual') {
                    document.getElementById('convenioGroup').classList.add('hidden');
                    document.getElementById('contactConvenio').required = false;
                }

                // Update views
                setTimeout(() => {
                    updateStats();
                    updateLeadsTable();
                }, 500);

                // Success message
                const successMsg = contactType === 'company'
                    ? `‚úÖ ¬°Contacto Empresarial guardado!

üè¢ ${savedContact.companyName}
üë§ ${savedContact.contactName} (${savedContact.contactPosition})
üìû ${savedContact.phone}
üî• Sistema funcionando correctamente`
                    : `‚úÖ ¬°Contacto Individual guardado!

üë§ ${savedContact.name}
üìû ${savedContact.phone}
üî• Sistema funcionando correctamente`;

                alert(successMsg);

            } catch (error) {
                console.error('‚ùå Error saving to Firebase:', error);
                alert(`‚ùå Error al guardar en Firebase: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // ========== CONTACT TYPE TAB SWITCHING ==========
        function switchContactType(type) {
            console.log('üîÑ Switching contact type to:', type);

            const generalTab = document.getElementById('generalContactTab');
            const companyTab = document.getElementById('companyContactTab');
            const generalForm = document.getElementById('generalContactForm');
            const companyForm = document.getElementById('companyContactForm');

            if (type === 'general') {
                // Show general form, hide company form
                generalForm.style.display = 'block';
                companyForm.style.display = 'none';

                // Update tab styles
                generalTab.style.background = '#667eea';
                generalTab.style.color = 'white';
                generalTab.classList.add('active');

                companyTab.style.background = 'white';
                companyTab.style.color = '#667eea';
                companyTab.classList.remove('active');

            } else if (type === 'company') {
                // Show company form, hide general form
                generalForm.style.display = 'none';
                companyForm.style.display = 'block';

                // Update tab styles
                companyTab.style.background = '#667eea';
                companyTab.style.color = 'white';
                companyTab.classList.add('active');

                generalTab.style.background = 'white';
                generalTab.style.color = '#667eea';
                generalTab.classList.remove('active');
            }

            console.log('‚úÖ Contact type switched successfully');
        }

        // ========== LEAD TYPE TAB SWITCHING ==========
        function switchLeadType(type) {
            console.log('üîÑ Switching lead type to:', type);

            const generalTab = document.getElementById('generalLeadTab');
            const companyTab = document.getElementById('companyLeadTab');
            const generalView = document.getElementById('generalLeadsView');
            const companyView = document.getElementById('companyLeadsView');

            if (type === 'general') {
                // Show general leads, hide company leads
                generalView.style.display = 'block';
                companyView.style.display = 'none';

                // Update tab styles
                generalTab.style.background = '#667eea';
                generalTab.style.color = 'white';
                generalTab.classList.add('active');

                companyTab.style.background = 'white';
                companyTab.style.color = '#667eea';
                companyTab.classList.remove('active');

                // Load individual leads
                updateLeadsTable('individual');

            } else if (type === 'company') {
                // Show company leads, hide general leads
                generalView.style.display = 'none';
                companyView.style.display = 'block';

                // Update tab styles
                companyTab.style.background = '#667eea';
                companyTab.style.color = 'white';
                companyTab.classList.add('active');

                generalTab.style.background = 'white';
                generalTab.style.color = '#667eea';
                generalTab.classList.remove('active');

                // Load company leads
                updateLeadsTable('company');
            }

            console.log('‚úÖ Lead type switched successfully');
        }

        // ========== SECTION 16.9: TAB NAVIGATION ==========
        function switchTab(tabName) {
            console.log('üìë Switching to tab:', tabName);
            
            try {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show target content
                const targetContent = document.getElementById(tabName);
                const targetTab = document.getElementById(tabName + 'Tab');
                
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                    console.log('‚úÖ Tab content shown:', tabName);
                }
                
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log('‚úÖ Tab activated:', tabName);
                }
                
                // Load tab-specific data
                if (tabName === 'leads') {
                    updateLeadsTable();
                } else if (tabName === 'config') {
                    loadConfigData();
                } else if (tabName === 'pipeline') {
                    loadPipelineData();
                } else if (tabName === 'reports') {
                    loadReportsData();
                } else if (tabName === 'tasks') {
                    if (typeof loadTasksTabEnhanced === 'function') {
                        loadTasksTabEnhanced();
                    } else {
                        console.error('‚ùå loadTasksTabEnhanced not loaded');
                    }
                } else if (tabName === 'admin') {
                    if (typeof loadAdminTab === 'function') {
                        loadAdminTab();
                    }
                } else if (tabName === 'auditLog') {
                    if (typeof loadAuditLogTab === 'function') {
                        loadAuditLogTab();
                    }
                } else if (tabName === 'coatsReports') {
                    // Load COATS Reports
                    if (window.CoatsReports) {
                        window.CoatsReports.renderReport('coatsReportContainer');
                    }
                }

                console.log('‚úÖ Tab switched successfully:', tabName);
                        
            } catch (error) {
                console.error('‚ùå Error switching tab:', error);
            }
        }

        // ========== SECTION 16.9.1: REPORTS FUNCTIONS ==========
        
        let currentReportsPeriod = 'monthly';
        let reportsCharts = {};

        async function loadReportsData() {
            console.log('üìä Loading reports data...');
            try {
                await window.ReportsManager.init();
                await refreshReports();
            } catch (error) {
                console.error('‚ùå Error loading reports:', error);
                showNotification('Error cargando reportes: ' + error.message, 'error');
            }
        }

        function updateReportsPeriod() {
            const period = document.getElementById('reportsPeriod').value;
            currentReportsPeriod = period;
            
            const customRange = document.getElementById('customDateRange');
            if (period === 'custom') {
                customRange.style.display = 'flex';
            } else {
                customRange.style.display = 'none';
            }
            
            refreshReports();
        }

        async function refreshReports() {
            try {
                console.log('üîÑ Refreshing reports for period:', currentReportsPeriod);
                
                let customStart = null, customEnd = null;
                if (currentReportsPeriod === 'custom') {
                    const startInput = document.getElementById('startDate');
                    const endInput = document.getElementById('endDate');
                    if (startInput.value) customStart = new Date(startInput.value);
                    if (endInput.value) customEnd = new Date(endInput.value);
                }

                // Generate all reports
                const [financialReport, studentReport, salesReport] = await Promise.all([
                    window.generateFinancialReport(currentReportsPeriod, customStart, customEnd),
                    window.generateStudentReport(currentReportsPeriod, customStart, customEnd),
                    window.generateSalesReport(currentReportsPeriod, customStart, customEnd)
                ]);

                // Update key metrics
                updateKeyMetrics(financialReport, studentReport, salesReport);

                // Update charts based on current tab
                const activeReportTab = document.querySelector('.report-tab.active');
                if (activeReportTab) {
                    const tabId = activeReportTab.id.replace('ReportTab', '');
                    updateReportCharts(tabId, { financial: financialReport, students: studentReport, sales: salesReport });
                }

                console.log('‚úÖ Reports refreshed successfully');
            } catch (error) {
                console.error('‚ùå Error refreshing reports:', error);
                showNotification('Error actualizando reportes: ' + error.message, 'error');
            }
        }

        function updateKeyMetrics(financialReport, studentReport, salesReport) {
            // Update metric cards
            document.getElementById('totalIncome').textContent = 
                window.ReportsManager.formatCurrency(financialReport.totalIncome);
            document.getElementById('activeStudents').textContent = studentReport.activeStudents;
            document.getElementById('newEnrollments').textContent = studentReport.newStudents;
            document.getElementById('pendingPayments').textContent = 
                window.ReportsManager.formatCurrency(financialReport.pendingPayments);
        }

        function switchReportTab(tabName) {
            console.log('üìä Switching to report tab:', tabName);
            
            // Update tab appearance
            document.querySelectorAll('.report-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName + 'ReportTab').classList.add('active');
            
            // Show/hide content
            document.querySelectorAll('.report-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName + 'Reports').classList.remove('hidden');
            
            // Load specific report data
            loadReportTab(tabName);
        }

        async function loadReportTab(tabName) {
            try {
                let customStart = null, customEnd = null;
                if (currentReportsPeriod === 'custom') {
                    const startInput = document.getElementById('startDate');
                    const endInput = document.getElementById('endDate');
                    if (startInput.value) customStart = new Date(startInput.value);
                    if (endInput.value) customEnd = new Date(endInput.value);
                }

                switch (tabName) {
                    case 'financial':
                        const financialReport = await window.generateFinancialReport(currentReportsPeriod, customStart, customEnd);
                        updateFinancialReports(financialReport);
                        break;
                    case 'students':
                        const studentReport = await window.generateStudentReport(currentReportsPeriod, customStart, customEnd);
                        updateStudentReports(studentReport);
                        break;
                    case 'sales':
                        const salesReport = await window.generateSalesReport(currentReportsPeriod, customStart, customEnd);
                        updateSalesReports(salesReport);
                        break;
                    case 'invoices':
                        const invoicesReport = await window.generateInvoicesReport();
                        updateInvoicesReports(invoicesReport);
                        break;
                }
            } catch (error) {
                console.error('‚ùå Error loading report tab:', error);
            }
        }

        function updateFinancialReports(report) {
            // Update financial details
            const detailsEl = document.getElementById('financialDetails');
            detailsEl.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h5>üí∞ Resumen de Ingresos</h5>
                        <p><strong>Total:</strong> ${window.ReportsManager.formatCurrency(report.totalIncome)}</p>
                        <p><strong>Promedio por pago:</strong> ${window.ReportsManager.formatCurrency(report.avgPaymentAmount)}</p>
                        <p><strong>Facturas pagadas:</strong> ${report.paidInvoices}</p>
                    </div>
                    <div>
                        <h5>‚è∞ Pagos Pendientes</h5>
                        <p><strong>Total:</strong> ${window.ReportsManager.formatCurrency(report.pendingPayments)}</p>
                        <p><strong>Total facturas:</strong> ${report.totalInvoices}</p>
                        <p><strong>Per√≠odo:</strong> ${window.ReportsManager.formatDateRange(report.dateRange.start, report.dateRange.end)}</p>
                    </div>
                </div>
            `;

            // Create charts
            createFinancialCharts(report);
        }

        function updateStudentReports(report) {
            // Update student details
            const detailsEl = document.getElementById('studentDetails');
            detailsEl.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h5>üë• Estad√≠sticas Generales</h5>
                        <p><strong>Total estudiantes:</strong> ${report.totalStudents}</p>
                        <p><strong>Estudiantes activos:</strong> ${report.activeStudents}</p>
                        <p><strong>Tasa de retenci√≥n:</strong> ${window.ReportsManager.formatPercent(report.retentionRate)}</p>
                    </div>
                    <div>
                        <h5>üìà Crecimiento</h5>
                        <p><strong>Nuevas matr√≠culas:</strong> ${report.newStudents}</p>
                        <p><strong>Estudiantes inactivos:</strong> ${report.inactiveStudents}</p>
                        <p><strong>Per√≠odo:</strong> ${window.ReportsManager.formatDateRange(report.dateRange.start, report.dateRange.end)}</p>
                    </div>
                </div>
            `;

            // Create charts
            createStudentCharts(report);
        }

        function updateSalesReports(report) {
            // Update sales details
            const detailsEl = document.getElementById('salesDetails');
            detailsEl.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h5>üéØ Rendimiento de Ventas</h5>
                        <p><strong>Total leads:</strong> ${report.totalLeads}</p>
                        <p><strong>Conversiones:</strong> ${report.conversions}</p>
                        <p><strong>Tasa de conversi√≥n:</strong> ${window.ReportsManager.formatPercent(report.conversionRate)}</p>
                    </div>
                    <div>
                        <h5>‚è±Ô∏è M√©tricas de Proceso</h5>
                        <p><strong>Tiempo resp. promedio:</strong> ${report.avgResponseTime}h</p>
                        <p><strong>Per√≠odo:</strong> ${window.ReportsManager.formatDateRange(report.dateRange.start, report.dateRange.end)}</p>
                    </div>
                </div>
            `;

            // Create charts
            createSalesCharts(report);
        }

        // Store invoices data for filtering
        let currentInvoicesData = [];

        function updateInvoicesReports(report) {
            currentInvoicesData = report.invoices;

            // Update summary stats
            document.getElementById('totalInvoicesCount').textContent = report.totalCount;
            document.getElementById('voidedInvoicesCount').textContent = report.voidedCount;
            document.getElementById('totalInvoicesAmount').textContent = window.ReportsManager.formatCurrency(report.totalActiveAmount);

            // Render table
            renderInvoicesTable(report.invoices);
        }

        function renderInvoicesTable(invoices) {
            const tbody = document.getElementById('invoicesReportBody');

            if (!invoices || invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No se encontraron facturas</td></tr>';
                return;
            }

            tbody.innerHTML = invoices.map(invoice => {
                const date = invoice.date instanceof Date ? invoice.date : new Date(invoice.date);
                const formattedDate = date.toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const statusStyle = invoice.isVoided
                    ? 'background: #f8d7da; color: #721c24; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: bold;'
                    : 'background: #d4edda; color: #155724; padding: 0.25rem 0.5rem; border-radius: 4px;';

                const statusText = invoice.isVoided ? 'ANULADA' : 'Activa';

                const rowStyle = invoice.isVoided ? 'background: #fff5f5;' : '';

                return `
                    <tr style="${rowStyle} border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 0.75rem;">${invoice.invoiceNumber || 'N/A'}</td>
                        <td style="padding: 0.75rem;">${formattedDate}</td>
                        <td style="padding: 0.75rem;">${invoice.studentName || invoice.customerName || 'N/A'}</td>
                        <td style="padding: 0.75rem; text-align: right;">${window.ReportsManager.formatCurrency(invoice.total || 0)}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span style="${statusStyle}">${statusText}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterInvoicesTable() {
            const searchTerm = document.getElementById('invoiceSearchInput').value.toLowerCase();
            const showVoidedOnly = document.getElementById('showVoidedOnly').checked;

            let filteredInvoices = currentInvoicesData;

            if (showVoidedOnly) {
                filteredInvoices = filteredInvoices.filter(i => i.isVoided);
            }

            if (searchTerm) {
                filteredInvoices = filteredInvoices.filter(i => {
                    const studentName = (i.studentName || i.customerName || '').toLowerCase();
                    const invoiceNumber = (i.invoiceNumber || '').toString().toLowerCase();
                    return studentName.includes(searchTerm) || invoiceNumber.includes(searchTerm);
                });
            }

            renderInvoicesTable(filteredInvoices);
        }

        function exportInvoicesData() {
            if (!currentInvoicesData || currentInvoicesData.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }

            const dataToExport = currentInvoicesData.map(invoice => {
                const date = invoice.date instanceof Date ? invoice.date : new Date(invoice.date);
                return {
                    'Factura #': invoice.invoiceNumber || 'N/A',
                    'Fecha': date.toLocaleDateString('es-CO'),
                    'Estudiante': invoice.studentName || invoice.customerName || 'N/A',
                    'Monto': invoice.total || 0,
                    'Estado': invoice.isVoided ? 'ANULADA' : 'Activa'
                };
            });

            window.ReportsManager.exportToCSV(dataToExport, 'facturas_reporte.csv');
            showNotification('Datos exportados exitosamente', 'success');
        }

        function createFinancialCharts(report) {
            // Destroy existing charts
            if (reportsCharts.dailyIncome) reportsCharts.dailyIncome.destroy();
            if (reportsCharts.paymentMethods) reportsCharts.paymentMethods.destroy();

            // Daily Income Chart
            const dailyLabels = Object.keys(report.dailyIncome);
            const dailyData = dailyLabels.map(date => 
                report.dailyIncome[date].reduce((sum, p) => sum + p.amount, 0)
            );

            reportsCharts.dailyIncome = window.ReportsManager.createLineChart(
                'dailyIncomeChart',
                dailyLabels,
                [{
                    label: 'Ingresos Diarios',
                    data: dailyData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)'
                }],
                'Ingresos por D√≠a'
            );

            // Payment Methods Chart
            const methodLabels = Object.keys(report.paymentMethods);
            const methodData = Object.values(report.paymentMethods);

            reportsCharts.paymentMethods = window.ReportsManager.createPieChart(
                'paymentMethodsChart',
                methodLabels,
                methodData,
                'Distribuci√≥n por M√©todo de Pago'
            );
        }

        function createStudentCharts(report) {
            // Destroy existing charts
            if (reportsCharts.enrollmentTrend) reportsCharts.enrollmentTrend.destroy();
            if (reportsCharts.coursePopularity) reportsCharts.coursePopularity.destroy();

            // Enrollment Trend Chart
            const trendLabels = Object.keys(report.enrollmentTrend);
            const trendData = trendLabels.map(month => report.enrollmentTrend[month].length);

            reportsCharts.enrollmentTrend = window.ReportsManager.createLineChart(
                'enrollmentTrendChart',
                trendLabels,
                [{
                    label: 'Matr√≠culas',
                    data: trendData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)'
                }],
                'Tendencia de Matr√≠culas'
            );

            // Course Popularity Chart
            const courseLabels = Object.keys(report.courseEnrollment);
            const courseData = Object.values(report.courseEnrollment);

            reportsCharts.coursePopularity = window.ReportsManager.createBarChart(
                'coursePopularityChart',
                courseLabels,
                [{
                    label: 'Estudiantes',
                    data: courseData,
                    backgroundColor: '#3b82f6'
                }],
                'Popularidad de Cursos'
            );
        }

        function createSalesCharts(report) {
            // Destroy existing charts
            if (reportsCharts.dailyLeads) reportsCharts.dailyLeads.destroy();
            if (reportsCharts.leadSources) reportsCharts.leadSources.destroy();

            // Daily Leads Chart
            const leadsLabels = Object.keys(report.dailyLeads);
            const leadsData = leadsLabels.map(date => report.dailyLeads[date].length);

            reportsCharts.dailyLeads = window.ReportsManager.createLineChart(
                'dailyLeadsChart',
                leadsLabels,
                [{
                    label: 'Leads',
                    data: leadsData,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)'
                }],
                'Leads por D√≠a'
            );

            // Lead Sources Chart
            const sourceLabels = Object.keys(report.leadSources);
            const sourceData = Object.values(report.leadSources);

            reportsCharts.leadSources = window.ReportsManager.createPieChart(
                'leadSourcesChart',
                sourceLabels,
                sourceData,
                'Fuentes de Leads'
            );
        }

        // Export functions
        async function exportReports() {
            try {
                const period = currentReportsPeriod;
                let customStart = null, customEnd = null;
                if (period === 'custom') {
                    const startInput = document.getElementById('startDate');
                    const endInput = document.getElementById('endDate');
                    if (startInput.value) customStart = new Date(startInput.value);
                    if (endInput.value) customEnd = new Date(endInput.value);
                }

                const reports = await Promise.all([
                    window.generateFinancialReport(period, customStart, customEnd),
                    window.generateStudentReport(period, customStart, customEnd),
                    window.generateSalesReport(period, customStart, customEnd)
                ]);

                const combinedData = {
                    financial: reports[0],
                    students: reports[1],
                    sales: reports[2],
                    generated: new Date(),
                    period: period
                };

                window.ReportsManager.exportToCSV([combinedData], `reporte_completo_${period}_${new Date().toISOString().split('T')[0]}.csv`);
                showNotification('‚úÖ Reporte exportado exitosamente', 'success');
            } catch (error) {
                console.error('‚ùå Error exporting reports:', error);
                showNotification('Error exportando reporte: ' + error.message, 'error');
            }
        }

        async function exportFinancialData() {
            try {
                const report = await window.generateFinancialReport(currentReportsPeriod);
                window.ReportsManager.exportToCSV([report], `reporte_financiero_${currentReportsPeriod}_${new Date().toISOString().split('T')[0]}.csv`);
                showNotification('‚úÖ Datos financieros exportados', 'success');
            } catch (error) {
                console.error('‚ùå Error exporting financial data:', error);
                showNotification('Error exportando datos financieros: ' + error.message, 'error');
            }
        }

        async function exportStudentData() {
            try {
                const report = await window.generateStudentReport(currentReportsPeriod);
                window.ReportsManager.exportToCSV([report], `reporte_estudiantes_${currentReportsPeriod}_${new Date().toISOString().split('T')[0]}.csv`);
                showNotification('‚úÖ Datos de estudiantes exportados', 'success');
            } catch (error) {
                console.error('‚ùå Error exporting student data:', error);
                showNotification('Error exportando datos de estudiantes: ' + error.message, 'error');
            }
        }

        async function exportSalesData() {
            try {
                const report = await window.generateSalesReport(currentReportsPeriod);
                window.ReportsManager.exportToCSV([report], `reporte_ventas_${currentReportsPeriod}_${new Date().toISOString().split('T')[0]}.csv`);
                showNotification('‚úÖ Datos de ventas exportados', 'success');
            } catch (error) {
                console.error('‚ùå Error exporting sales data:', error);
                showNotification('Error exportando datos de ventas: ' + error.message, 'error');
            }
        }

        // ========== SECTION 16.10: USER MANAGEMENT FUNCTIONS ==========
        async function handleCreateUser(event) {
            event.preventDefault();
            
            const createBtn = event.target.querySelector('button[type="submit"]');
            const originalText = createBtn.innerHTML;
            
            try {
                createBtn.disabled = true;
                createBtn.innerHTML = '<div class="loading-spinner" style="width: 12px; height: 12px; display: inline-block; margin-right: 0.5rem;"></div>Creando...';
                
                const name = document.getElementById('newUserName').value.trim();
                const email = document.getElementById('newUserEmail').value.trim();
                const password = document.getElementById('newUserPassword').value;
                const role = document.getElementById('newUserRole').value;
                
                console.log('üìù Creating user:', { name, email, role });
                
                // Create user in Firebase
                const newUser = await window.FirebaseData.createUser(email, password, {
                    name: name,
                    role: role
                });
                
                console.log('‚úÖ User created:', newUser.uid);
                
                // Clear form
                event.target.reset();
                
                alert(`‚úÖ Usuario creado exitosamente!\n\nNombre: ${name}\nEmail: ${email}\nRol: ${role}\n\nYa puede iniciar sesi√≥n.`);
                
                // Reload users list
                setTimeout(() => loadUsersList(), 1000);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                
                let errorMessage = 'Error al crear usuario';
                if (error.message.includes('email-already-in-use')) {
                    errorMessage = 'Este email ya est√° registrado';
                } else if (error.message.includes('weak-password')) {
                    errorMessage = 'La contrase√±a debe tener al menos 6 caracteres';
                } else if (error.message.includes('invalid-email')) {
                    errorMessage = 'Email inv√°lido';
                }
                
                alert(`‚ùå ${errorMessage}`);
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = originalText;
            }
        }

        async function loadUsersList() {
            try {
                console.log('üìã Loading users list...');
                
                const usersListEl = document.getElementById('usersList');
                if (!usersListEl) {
                    console.log('‚ùå usersList element not found');
                    return;
                }
                
                usersListEl.innerHTML = '<div class="loading-spinner"></div> Cargando usuarios...';
                
                // Get all users
                const users = await window.FirebaseData.getAllUsers();
                console.log('üë• Users loaded:', users);
                
                if (!users || Object.keys(users).length === 0) {
                    usersListEl.innerHTML = '<p style="color: #6b7280;">No hay usuarios registrados</p>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 0.5rem;">';
                
                Object.entries(users).forEach(([userId, user]) => {
                    const roleEmoji = user.role === 'director' ? 'üëë' : 'üë§';
                    const roleColor = user.role === 'director' ? '#f59e0b' : '#3b82f6';
                    const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('es-ES') : 'N/A';
                    
                    html += `
                        <div style="
                            background: #f9fafb;
                            padding: 1rem;
                            border-radius: 8px;
                            border: 1px solid #e5e7eb;
                        ">
                            <div style="font-weight: 600;">${user.name || 'Sin nombre'}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">${user.email || 'Sin email'}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                <span style="
                                    background: ${roleColor};
                                    color: white;
                                    padding: 0.125rem 0.5rem;
                                    border-radius: 12px;
                                    font-size: 0.75rem;
                                    font-weight: 600;
                                ">
                                    ${roleEmoji} ${user.role || 'vendedor'}
                                </span>
                                <span style="font-size: 0.75rem; color: #9ca3af;">
                                    ${createdDate}
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                usersListEl.innerHTML = html;
                
                console.log('‚úÖ Users list loaded with', Object.keys(users).length, 'users');
                
            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                const usersListEl = document.getElementById('usersList');
                if (usersListEl) {
                    usersListEl.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${error.message}</p>`;
                }
            }
        }

        // ========== SECTION 16.11: STATS UPDATE FUNCTIONS ==========
        async function updateStats() {
            try {
                console.log('üìä Updating stats');
                
                if (!window.FirebaseData || !window.FirebaseData.currentUser) {
                    console.log('‚ö†Ô∏è Firebase not available for stats');
                    return;
                }
                
                const allContacts = await window.FirebaseData.getFilteredContacts();
                const today = new Date().toISOString().split('T')[0];
                
                const todayContacts = allContacts.filter(c => c.date === today);
                const activeLeads = allContacts.filter(c => !['Convertido', 'Perdido'].includes(c.status));
                const conversions = allContacts.filter(c => c.status === 'Convertido');
                
                const totalLeadsEl = document.getElementById('totalLeads');
                const activeLeadsEl = document.getElementById('activeLeads');
                const conversionsEl = document.getElementById('conversions');
                
                if (totalLeadsEl) totalLeadsEl.textContent = allContacts.length;
                if (activeLeadsEl) activeLeadsEl.textContent = activeLeads.length;
                if (conversionsEl) conversionsEl.textContent = conversions.length;
                
                console.log('‚úÖ Stats updated successfully');
                
            } catch (error) {
                console.error('‚ùå Error updating stats:', error);
            }
        }

        // ========== SECTION 16.12: LEADS TABLE FUNCTIONS ==========
        async function updateLeadsTable(contactTypeFilter = 'individual') {
            try {
                console.log('üìã Updating leads table for type:', contactTypeFilter);

                if (!window.FirebaseData || !window.FirebaseData.currentUser) {
                    console.log('‚ùå Firebase not available');
                    const tbody = contactTypeFilter === 'company' ? document.getElementById('companyLeadsTable') : document.getElementById('leadsTable');
                    if (tbody) {
                        const colspan = contactTypeFilter === 'company' ? '9' : '6';
                        tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; color: #dc2626; padding: 2rem;">‚ùå Firebase no disponible</td></tr>`;
                    }
                    return;
                }

                const userProfile = await window.FirebaseData.loadUserProfile();
                if (!userProfile) {
                    console.log('‚ùå No user profile available');
                    return;
                }

                let data = await window.FirebaseData.getFilteredContacts();
                console.log('üìä All contacts:', data.length, 'records');

                // FILTER BY CONTACT TYPE
                data = data.filter(contact => {
                    const type = contact.contactType || 'individual';
                    return type === contactTypeFilter;
                });

                console.log(`üìä Filtered ${contactTypeFilter} contacts:`, data.length, 'records');

                const tbody = contactTypeFilter === 'company' ? document.getElementById('companyLeadsTable') : document.getElementById('leadsTable');
                if (!tbody) {
                    console.log('‚ùå Table not found');
                    return;
                }

                if (data.length === 0) {
                    const colspan = contactTypeFilter === 'company' ? '9' : (userProfile.role === 'director' ? '7' : '6');
                    const message = contactTypeFilter === 'company' ? 'No hay contactos empresariales registrados' : 'No hay leads individuales registrados';
                    tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; color: #666; padding: 2rem;">${message}</td></tr>`;
                    return;
                }

                // Sort by date (newest first)
                data.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || '00:00:00'));
                    const dateB = new Date(b.date + ' ' + (b.time || '00:00:00'));
                    return dateB - dateA;
                });

                // Generate table rows
                const rows = [];

                if (contactTypeFilter === 'company') {
                    // COMPANY LEADS TABLE
                    for (const lead of data) {
                        try {
                            const salespersonCell = userProfile.role === 'director'
                                ? `<td><span style="background: #667eea; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">${await getUserDisplayName(lead.salespersonId)}</span></td>`
                                : '';

                            const deleteButton = (userProfile.role === 'director' || userProfile.role === 'admin')
                                ? `<button onclick="deleteLead('${lead.id}')" class="btn btn-warning" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #ef4444;">üóëÔ∏è</button>`
                                : `<span style="color: #9ca3af; font-size: 0.75rem;">Solo lectura</span>`;

                            rows.push(`
                                <tr>
                                    <td style="font-weight: 500;">${lead.companyName || 'Sin nombre'}</td>
                                    <td>${lead.companyType || '-'}</td>
                                    <td>${lead.contactName || '-'}</td>
                                    <td style="font-size: 0.85rem;">${lead.contactPosition || '-'}</td>
                                    <td>${lead.phone || '-'}</td>
                                    <td style="text-align: center;">${lead.estimatedLeads || 0}</td>
                                    <td style="font-size: 0.85rem;">${lead.serviceType || '-'}</td>
                                    <td style="font-size: 0.9rem;">${formatDate(lead.date)}</td>
                                    <td>
                                        <button onclick="showLeadDetails('${lead.id}')" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;">
                                            üìã Ver
                                        </button>
                                        ${deleteButton}
                                    </td>
                                </tr>
                            `);
                        } catch (rowError) {
                            console.error('‚ùå Error rendering company row:', lead.id, rowError);
                        }
                    }

                } else {
                    // INDIVIDUAL LEADS TABLE
                    for (const lead of data) {
                        try {
                            const salespersonCell = userProfile.role === 'director'
                                ? `<td><span style="background: #667eea; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">${await getUserDisplayName(lead.salespersonId)}</span></td>`
                                : '';

                            const source = lead.source || 'No especificado';
                            const sourceDisplay = source.length > 30 ? source.substring(0, 30) + '...' : source;

                            const deleteButton = (userProfile.role === 'director' || userProfile.role === 'admin')
                                ? `<button onclick="deleteLead('${lead.id}')" class="btn btn-warning" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #ef4444;">üóëÔ∏è</button>`
                                : `<span style="color: #9ca3af; font-size: 0.75rem;">Solo lectura</span>`;

                            rows.push(`
                                <tr>
                                    <td style="font-weight: 500;">${lead.name || 'Sin nombre'}</td>
                                    <td>${lead.phone || 'Sin tel√©fono'}</td>
                                    <td style="font-size: 0.9rem;">${sourceDisplay}</td>
                                    <td><span class="status-badge status-${(lead.status || 'nuevo').toLowerCase().replace(' ', '').replace('√≥', 'o')}">${lead.status || 'Nuevo'}</span></td>
                                    <td style="font-size: 0.9rem;">${formatDate(lead.date)}</td>
                                    ${salespersonCell}
                                    <td>
                                        <button onclick="showLeadDetails('${lead.id}')" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;">
                                            üìã Ver
                                        </button>
                                        ${deleteButton}
                                    </td>
                                </tr>
                            `);
                        } catch (rowError) {
                            console.error('‚ùå Error rendering individual row:', lead.id, rowError);
                        }
                    }
                }

                tbody.innerHTML = rows.join('');
                console.log('‚úÖ Leads table updated with', data.length, 'records');

            } catch (error) {
                console.error('‚ùå Error updating leads table:', error);
                const tbody = contactTypeFilter === 'company' ? document.getElementById('companyLeadsTable') : document.getElementById('leadsTable');
                if (tbody) {
                    const colspan = contactTypeFilter === 'company' ? '9' : '6';
                    tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; color: #dc2626; padding: 2rem;">‚ùå Error: ${error.message}</td></tr>`;
                }
            }
        }

        // ========== SECTION 16.13: PIPELINE FUNCTIONS ==========
        async function loadPipelineData() {
            try {
                console.log('üéØ Loading pipeline data');
                
                const container = document.getElementById('pipelineContainer');
                if (!container) return;
                
                if (!window.FirebaseData || !window.FirebaseData.currentUser) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #dc2626; padding: 2rem;">
                            ‚ùå Firebase no disponible
                        </div>
                    `;
                    return;
                }
                
                const allContacts = await window.FirebaseData.getFilteredContacts();
                
                if (allContacts.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üéØ</div>
                            <h3>No hay leads en el pipeline</h3>
                            <p>Agrega contactos para verlos en el pipeline</p>
                            <button onclick="switchTab('contacts')" class="btn btn-primary" style="margin-top: 1rem;">‚ûï Agregar Contactos</button>
                        </div>
                    `;
                    return;
                }
                
                // Group contacts by status
                const statusGroups = {
                    'Nuevo': { leads: [], color: '#fbbf24', emoji: 'üü°' },
                    'Contactado': { leads: [], color: '#3b82f6', emoji: 'üîµ' },
                    'Interesado': { leads: [], color: '#10b981', emoji: 'üü¢' },
                    'Negociaci√≥n': { leads: [], color: '#f97316', emoji: 'üü†' },
                    'Convertido': { leads: [], color: '#22c55e', emoji: '‚úÖ' },
                    'Perdido': { leads: [], color: '#ef4444', emoji: '‚ùå' }
                };
                
                allContacts.forEach(contact => {
                    const status = contact.status || 'Nuevo';
                    if (statusGroups[status]) {
                        statusGroups[status].leads.push(contact);
                    }
                });
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        ${Object.entries(statusGroups).map(([status, group]) => `
                            <div class="pipeline-column" style="border-top: 4px solid ${group.color};">
                                <div class="pipeline-header" style="background: ${group.color}15;">
                                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">
                                        ${group.emoji} ${status}
                                    </div>
                                    <div style="
                                        background: ${group.color};
                                        color: white;
                                        display: inline-block;
                                        padding: 0.25rem 0.75rem;
                                        border-radius: 20px;
                                        font-weight: 600;
                                        font-size: 0.9rem;
                                    ">
                                        ${group.leads.length} leads
                                    </div>
                                </div>
                                <div class="pipeline-body">
                                    ${group.leads.length === 0 ? `
                                        <div style="text-align: center; color: #6b7280; padding: 2rem;">
                                            Sin leads en esta etapa
                                        </div>
                                    ` : group.leads.map(lead => `
                                        <div class="lead-card" onclick="showLeadDetails('${lead.id}')">
                                            <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                                ${lead.name || 'Sin nombre'}
                                            </div>
                                            <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">
                                                üìû ${lead.phone || 'Sin tel√©fono'}
                                            </div>
                                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">
                                                üìç ${(lead.source || 'No especificado').length > 25 ? (lead.source || 'No especificado').substring(0, 25) + '...' : (lead.source || 'No especificado')}
                                            </div>
                                            <div style="font-size: 0.8rem; color: #6b7280;">
                                                üìÖ ${formatDate(lead.date)}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Pipeline Summary -->
                    <div style="margin-top: 2rem; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 1rem 0;">üìä Resumen del Pipeline</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${allContacts.length}</div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Total Leads</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">${statusGroups['Convertido'].leads.length}</div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Convertidos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${statusGroups['Negociaci√≥n'].leads.length}</div>
                                <div style="font-size: 0.9rem; color: #6b7280;">En Negociaci√≥n</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">
                                    ${allContacts.length > 0 ? ((statusGroups['Convertido'].leads.length / allContacts.length) * 100).toFixed(1) : 0}%
                                </div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Tasa Conversi√≥n</div>
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ Pipeline data loaded');
                
            } catch (error) {
                console.error('‚ùå Error loading pipeline data:', error);
                const container = document.getElementById('pipelineContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #dc2626; padding: 2rem;">
                            ‚ùå Error cargando pipeline: ${error.message}
                        </div>
                    `;
                }
            }
        }

        async function refreshPipeline() {
            console.log('üîÑ Refreshing pipeline');
            await loadPipelineData();
        }

        // ========== SECTION 16.14: REPORTS FUNCTIONS ==========
        async function loadReportsData() {
            try {
                console.log('üìä Loading reports data');
                
                if (!window.FirebaseData || !window.FirebaseData.currentUser) {
                    console.log('‚ö†Ô∏è Firebase not available for reports');
                    return;
                }
                
                const userProfile = await window.FirebaseData.loadUserProfile();
                const allContacts = await window.FirebaseData.getFilteredContacts();
                
                if (userProfile.role === 'director') {
                    await loadDirectorReports(allContacts);
                } else {
                    await loadPersonalReports(allContacts);
                }
                
            } catch (error) {
                console.error('‚ùå Error loading reports data:', error);
            }
        }

        async function loadPersonalReports(contacts) {
            const weeklyPerformanceEl = document.getElementById('weeklyPerformance');
            const personalTargetsEl = document.getElementById('personalTargets');
            
            if (!weeklyPerformanceEl || !personalTargetsEl) return;
            
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            
            const thisWeekContacts = contacts.filter(c => {
                const contactDate = new Date(c.date);
                return contactDate >= weekStart;
            });
            
            const conversions = contacts.filter(c => c.status === 'Convertido');
            const conversionRate = contacts.length > 0 ? (conversions.length / contacts.length * 100).toFixed(1) : 0;
            
            weeklyPerformanceEl.innerHTML = `
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <h4 style="margin: 0 0 1rem 0; color: #374151;">üìà Rendimiento Semanal</h4>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Contactos esta semana:</span>
                            <strong>${thisWeekContacts.length}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Total contactos:</span>
                            <strong>${contacts.length}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Conversiones:</span>
                            <strong>${conversions.length}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Tasa de conversi√≥n:</span>
                            <strong style="color: #10b981;">${conversionRate}%</strong>
                        </div>
                    </div>
                </div>
            `;
            
            const dailyGoal = 10;
            const todayContacts = contacts.filter(c => c.date === today.toISOString().split('T')[0]).length;
            const goalProgress = (todayContacts / dailyGoal * 100).toFixed(1);
            
            personalTargetsEl.innerHTML = `
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <h4 style="margin: 0 0 1rem 0; color: #374151;">üéØ Objetivos Personales</h4>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Meta diaria:</span>
                            <strong>${dailyGoal} contactos</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Contactos hoy:</span>
                            <strong>${todayContacts}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <span>Progreso:</span>
                            <strong style="color: ${goalProgress >= 100 ? '#10b981' : '#f59e0b'};">${goalProgress}%</strong>
                        </div>
                        <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="
                                background: ${goalProgress >= 100 ? '#10b981' : '#f59e0b'};
                                height: 8px;
                                width: ${Math.min(goalProgress, 100)}%;
                                transition: width 0.5s ease;
                            "></div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadDirectorReports(contacts) {
            const teamPerformanceEl = document.getElementById('teamPerformance');
            const salesRankingEl = document.getElementById('salesRanking');
            const executiveSummaryEl = document.getElementById('executiveSummary');
            const directorReportsEl = document.getElementById('directorReports');
            const personalReportsEl = document.getElementById('personalReports');
            
            if (directorReportsEl) directorReportsEl.classList.remove('hidden');
            if (personalReportsEl) personalReportsEl.classList.add('hidden');
            
            if (!teamPerformanceEl || !salesRankingEl || !executiveSummaryEl) return;
            
            // Team Performance
            const today = new Date().toISOString().split('T')[0];
            const todayContacts = contacts.filter(c => c.date === today);
            const conversions = contacts.filter(c => c.status === 'Convertido');
            const activeLeads = contacts.filter(c => !['Convertido', 'Perdido'].includes(c.status));
            
            teamPerformanceEl.innerHTML = `
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <h4 style="margin: 0 0 1rem 0; color: #374151;">üë• Rendimiento del Equipo</h4>
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2rem; font-weight: bold; color: #3b82f6; margin-bottom: 0.5rem;">
                            ${contacts.length}
                        </div>
                        <div style="color: #6b7280;">Total Leads</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                        <div>Hoy: <strong>${todayContacts.length}</strong></div>
                        <div>Activos: <strong>${activeLeads.length}</strong></div>
                        <div>Convertidos: <strong>${conversions.length}</strong></div>
                        <div>Tasa: <strong>${contacts.length > 0 ? ((conversions.length / contacts.length) * 100).toFixed(1) : 0}%</strong></div>
                    </div>
                </div>
            `;
            
            // Sales Ranking - This section continues with the existing code...
            try {
                const allUsers = await window.FirebaseData.getAllUsers();
                const salespeople = Object.entries(allUsers).filter(([uid, user]) => user.role === 'vendedor');
                
                const rankings = salespeople.map(([uid, user]) => {
                    const userContacts = contacts.filter(c => c.salespersonId === uid);
                    const userConversions = userContacts.filter(c => c.status === 'Convertido');
                    return {
                        name: user.name,
                        contacts: userContacts.length,
                        conversions: userConversions.length
                    };
                }).sort((a, b) => b.conversions - a.conversions);
                
                salesRankingEl.innerHTML = `
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                        <h4 style="margin: 0 0 1rem 0; color: #374151;">üèÜ Ranking de Ventas</h4>
                        ${rankings.length === 0 ? `
                            <div style="text-align: center; color: #6b7280; padding: 1rem;">
                                No hay vendedores registrados
                            </div>
                        ` : rankings.slice(0, 3).map((person, index) => `
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 0.75rem;
                                margin-bottom: 0.5rem;
                                background: ${index === 0 ? '#fef3c7' : index === 1 ? '#e5e7eb' : '#fecaca'};
                                border-radius: 8px;
                            ">
                                <div>
                                    <span style="margin-right: 0.5rem;">
                                        ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â'}
                                    </span>
                                    <strong>${person.name}</strong>
                                </div>
                                <div style="text-align: right; font-size: 0.9rem;">
                                    <div><strong>${person.conversions}</strong> conversiones</div>
                                    <div style="color: #6b7280;">${person.contacts} contactos</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Error loading sales ranking:', error);
                salesRankingEl.innerHTML = `
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                        <h4 style="margin: 0 0 1rem 0; color: #374151;">üèÜ Ranking de Ventas</h4>
                        <div style="text-align: center; color: #dc2626; padding: 1rem;">
                            Error cargando ranking
                        </div>
                    </div>
                `;
            }
            
            // Executive Summary
            const sourcesBreakdown = {};
            contacts.forEach(contact => {
                const source = contact.source || 'No especificado';
                sourcesBreakdown[source] = (sourcesBreakdown[source] || 0) + 1;
            });
            
            const topSource = Object.entries(sourcesBreakdown).sort((a, b) => b[1] - a[1])[0];
            
            executiveSummaryEl.innerHTML = `
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <h4 style="margin: 0 0 1rem 0; color: #374151;">üìà Resumen Ejecutivo</h4>
                    <div style="font-size: 0.9rem; line-height: 1.6;">
                        <div style="margin-bottom: 1rem;">
                            <strong>Estado General:</strong><br>
                            El equipo tiene ${contacts.length} leads totales con una tasa de conversi√≥n del ${contacts.length > 0 ? ((conversions.length / contacts.length) * 100).toFixed(1) : 0}%.
                        </div>
                        ${topSource ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Mejor Fuente:</strong><br>
                                ${topSource[0]} con ${topSource[1]} leads.
                            </div>
                        ` : ''}
                        <div>
                            <strong>Recomendaci√≥n:</strong><br>
                            ${activeLeads.length > 0 ? 
                                `Seguir con los ${activeLeads.length} leads activos en pipeline.` : 
                                'Enfocar esfuerzos en generar nuevos leads.'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== SECTION 16.15: CONFIG FUNCTIONS ==========
        async function loadConfigData() {
            try {
                console.log('‚öôÔ∏è Loading config data');
                await updateConveniosList();
            } catch (error) {
                console.error('‚ùå Error loading config data:', error);
            }
        }

        async function updateConveniosList() {
            try {
                const conveniosList = document.getElementById('conveniosList');
                if (!conveniosList) return;
                
                conveniosList.innerHTML = '<div class="loading-spinner"></div> Cargando convenios...';
                
                const convenios = await window.FirebaseData.getConvenios();
                
                if (!convenios || convenios.length === 0) {
                    conveniosList.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ü§ù</div>
                            <p>No hay convenios registrados</p>
                        </div>
                    `;
                    return;
                }
                
                conveniosList.innerHTML = convenios.map((convenio, index) => `
                    <div style="background: #f9fafb; padding: 0.75rem; border-radius: 5px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #10b981;">
                        <span>${convenio}</span>
                        <button onclick="deleteConvenio('${convenio}')" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.8rem;">
                            üóëÔ∏è
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('‚ùå Error updating convenios list:', error);
            }
        }

        async function addConvenio() {
            try {
                const input = document.getElementById('newConvenio');
                const convenioName = input.value.trim();
                
                if (!convenioName) {
                    alert('‚ö†Ô∏è Ingresa el nombre del convenio');
                    return;
                }
                
                const currentConvenios = await window.FirebaseData.getConvenios();
                
                if (currentConvenios.includes(convenioName)) {
                    alert('‚ö†Ô∏è Este convenio ya existe');
                    return;
                }
                
                const updatedConvenios = [...currentConvenios, convenioName];
                await window.FirebaseData.updateConvenios(updatedConvenios);
                
                input.value = '';
                cachedConvenios = updatedConvenios;
                await updateConveniosList();
                
                alert(`‚úÖ Convenio "${convenioName}" agregado correctamente`);
                
            } catch (error) {
                console.error('‚ùå Error adding convenio:', error);
                alert('‚ùå Error al agregar convenio');
            }
        }

        async function deleteConvenio(convenioName) {
            try {
                if (confirm(`¬øEst√°s seguro de eliminar el convenio "${convenioName}"?`)) {
                    const currentConvenios = await window.FirebaseData.getConvenios();
                    const updatedConvenios = currentConvenios.filter(c => c !== convenioName);
                    await window.FirebaseData.updateConvenios(updatedConvenios);
                    
                    cachedConvenios = updatedConvenios;
                    await updateConveniosList();
                    alert(`‚úÖ Convenio "${convenioName}" eliminado correctamente`);
                }
            } catch (error) {
                console.error('‚ùå Error deleting convenio:', error);
                alert('‚ùå Error al eliminar convenio');
            }
        }

        // ========== SECTION 16.16: UTILITY FUNCTIONS ==========
        async function getUserDisplayName(userId) {
            try {
                if (!userId) return 'Unknown User';
                
                const allUsers = await window.FirebaseData.getAllUsers();
                const user = allUsers[userId];
                
                if (user && user.name) {
                    return user.name;
                }
                
                if (user && user.email) {
                    return user.email.split('@')[0];
                }
                
                return 'Unknown User';
            } catch (error) {
                console.error('‚ùå Error getting user display name:', error);
                return 'Unknown User';
            }
        }

        function formatDate(dateString) {
            try {
                if (!dateString) return 'Sin fecha';
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES');
            } catch (error) {
                return dateString || 'Sin fecha';
            }
        }

        async function refreshAllData() {
            try {
                console.log('üîÑ Refreshing all data');
                
                await updateStats();
                await updateLeadsTable();
                
                alert('‚úÖ Datos actualizados');
                
            } catch (error) {
                console.error('‚ùå Error refreshing data:', error);
                alert('‚ùå Error al actualizar datos');
            }
        }

        async function handleLogout() {
            try {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    await window.FirebaseData.logout();

                    currentUser = null;
                    window.userRole = null;
                    userRole = null;
                    isInitialized = false;
                    
                    document.getElementById('mainApp').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    
                    alert('üëã Sesi√≥n cerrada correctamente');
                }
            } catch (error) {
                console.error('‚ùå Logout error:', error);
                alert('‚ùå Error al cerrar sesi√≥n');
            }
        }

        // ========== SECTION 16.17: TEST FUNCTIONS ==========
        async function testConveniosSystem() {
            try {
                const results = {
                    firebaseAvailable: !!window.FirebaseData,
                    conveniosFunction: typeof window.FirebaseData?.getConvenios === 'function',
                    conveniosLoaded: 0,
                    handleSourceChangeExists: typeof handleSourceChange === 'function',
                    domElements: {
                        sourceSelect: !!document.getElementById('contactSource'),
                        convenioGroup: !!document.getElementById('convenioGroup'),
                        convenioSelect: !!document.getElementById('contactConvenio')
                    }
                };
                
                if (results.firebaseAvailable && results.conveniosFunction) {
                    const convenios = await window.FirebaseData.getConvenios();
                    results.conveniosLoaded = convenios ? convenios.length : 0;
                }
                
                const allWorking = results.firebaseAvailable && 
                                  results.conveniosFunction && 
                                  results.handleSourceChangeExists && 
                                  Object.values(results.domElements).every(v => v);
                
                alert(`üß™ TEST CONVENIOS SYSTEM:

üî• Firebase: ${results.firebaseAvailable ? '‚úÖ' : '‚ùå'}
‚öôÔ∏è Funci√≥n Convenios: ${results.conveniosFunction ? '‚úÖ' : '‚ùå'}
üìã Convenios Cargados: ${results.conveniosLoaded}
üîß Handle Function: ${results.handleSourceChangeExists ? '‚úÖ' : '‚ùå'}

üìã ELEMENTOS DOM:
- Source Select: ${results.domElements.sourceSelect ? '‚úÖ' : '‚ùå'}
- Convenio Group: ${results.domElements.convenioGroup ? '‚úÖ' : '‚ùå'}
- Convenio Select: ${results.domElements.convenioSelect ? '‚úÖ' : '‚ùå'}

üéØ ESTADO: ${allWorking ? '‚úÖ FUNCIONANDO PERFECTAMENTE' : '‚ö†Ô∏è REVISAR'}`);
                
            } catch (error) {
                console.error('‚ùå Error testing convenios system:', error);
                alert(`‚ùå Error testing convenios: ${error.message}`);
            }
        }

        async function testTabSystem() {
            try {
                const tabs = ['contacts', 'leads', 'pipeline', 'reports'];
                let working = 0;
                
                for (const tab of tabs) {
                    try {
                        switchTab(tab);
                        const content = document.getElementById(tab);
                        if (content && !content.classList.contains('hidden')) {
                            working++;
                        }
                    } catch (error) {
                        console.error('Error testing tab:', tab, error);
                    }
                }
                
                // Reset to contacts tab
                switchTab('contacts');
                
                alert(`üß™ TEST TAB SYSTEM:

üìë Tabs Funcionando: ${working}/${tabs.length}
üéØ Estado: ${working === tabs.length ? '‚úÖ TODAS LAS TABS FUNCIONAN' : '‚ö†Ô∏è ALGUNAS TABS TIENEN PROBLEMAS'}

Tabs Probadas:
${tabs.map(tab => `- ${tab}: ${document.getElementById(tab) ? '‚úÖ' : '‚ùå'}`).join('\n')}`);
                
            } catch (error) {
                alert(`‚ùå Error testing tabs: ${error.message}`);
            }
        }

        // ========== SECTION 16.18: ACTION HANDLERS ==========
        function showLeadDetails(leadId) {
            alert(`üìã Ver detalles del lead: ${leadId}\n\n‚úÖ Sistema funcionando correctamente`);
        }

        async function deleteLead(leadId) {
            try {
                console.log('üóëÔ∏è Attempting to delete lead:', leadId);
                
                if (!window.FirebaseData) {
                    alert('‚ùå Sistema no disponible');
                    return;
                }
                
                // Show confirmation dialog
                const confirmDelete = confirm('¬øEst√°s seguro de eliminar este lead?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.');
                
                if (!confirmDelete) {
                    console.log('‚ùå Deletion cancelled by user');
                    return;
                }
                
                // Show loading notification
                if (typeof showNotification === 'function') {
                    showNotification('üîÑ Eliminando lead...', 'info');
                }
                
                // Delete from Firebase
                const deleted = await window.FirebaseData.deleteContact(leadId);
                
                if (deleted) {
                    console.log('‚úÖ Lead deleted successfully');
                    
                    // Show success notification
                    if (typeof showNotification === 'function') {
                        showNotification('‚úÖ Lead eliminado correctamente', 'success');
                    } else {
                        alert('‚úÖ Lead eliminado correctamente');
                    }
                    
                    // Refresh the leads table
                    if (typeof updateLeadsTable === 'function') {
                        setTimeout(() => updateLeadsTable(), 500);
                    }
                    
                    // Update stats
                    if (typeof updateStats === 'function') {
                        setTimeout(() => updateStats(), 500);
                    }
                    
                    // Refresh pipeline if on that tab
                    if (window.appState && window.appState.currentTab === 'pipeline' && typeof loadPipelineData === 'function') {
                        setTimeout(() => loadPipelineData(), 500);
                    }
                    
                } else {
                    console.error('‚ùå Failed to delete lead');
                    if (typeof showNotification === 'function') {
                        showNotification('‚ùå Error al eliminar el lead', 'error');
                    } else {
                        alert('‚ùå Error al eliminar el lead');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error deleting lead:', error);
                
                let errorMessage = 'Error al eliminar el lead';
                if (error.message.includes('only delete your own contacts')) {
                    errorMessage = 'Solo puedes eliminar tus propios contactos';
                }
                
                if (typeof showNotification === 'function') {
                    showNotification(`‚ùå ${errorMessage}`, 'error');
                } else {
                    alert(`‚ùå ${errorMessage}`);
                }
            }
        }
        
        function exportTodayContacts() {
            alert('üì• Exportar contactos de hoy\n\n‚úÖ Sistema funcionando correctamente');
        }

        console.log('‚úÖ Complete CRM System loaded successfully');
        
        // ========== SECTION 16.19: CRITICAL MISSING FUNCTIONS (FIXES) ==========
        
        // Fix showNotification function (PRIORITY 1)
        function showNotification(message, type = 'info', duration = 5000) {
            // Remove existing notifications
            const existing = document.querySelectorAll('.notification-toast');
            existing.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification-toast notification-${type}`;
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 400px;
                font-size: 0.9rem;
                line-height: 1.4;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                white-space: pre-line;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>${message}</div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: 1rem; opacity: 0.8;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove
            if (duration > 0) {
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }

        // ========== SECTION 16.20: PLACEHOLDER FOR TASKS FUNCTION ==========
        // Placeholder function - actual implementation loaded from tasks-enhanced.js
        function loadTasksData() {
            console.log('üìã Loading enhanced tasks data - function will be loaded from tasks-enhanced.js');
            if (typeof loadTasksTabEnhanced === 'function') {
                loadTasksTabEnhanced();
            }
        }
    </script>

    <!-- ========== SECTION 17: EXTERNAL MODULE SCRIPTS ========== -->
    <!-- Date utilities must load first (used by finance, payments, tienda) -->
    <script src="date-utils.js"></script>
    <script src="fixes.js"></script>
    <script src="social.js"></script>
    <script src="pipeline.js"></script>
    <script src="debug-permissions.js"></script>
    <script src="employees.js"></script>
    <script src="tasks-enhanced.js"></script>
    <script src="students.js"></script>
    <script src="payments.js"></script>
    <script src="tienda.js"></script>
    <script src="groups.js"></script>
    <script src="grupos2.js"></script>
    <script src="teachers.js"></script>
    <script src="attendance.js"></script>
    <script src="school-buttons.js"></script>
    <script src="import-students.js"></script>
    <script src="invoice-integration.js"></script>
    <script src="reports.js"></script>
    <script src="coats-reports.js?v=20251212u"></script>
    <script src="finance.js"></script>
    <script src="payroll.js"></script>
    <script src="payroll-import.js"></script>
    <script src="fix-dates.js"></script>
    <script src="admin-center.js"></script>
    <script src="auditlog.js"></script>
    <script src="permission-enforcer.js"></script>

    <!-- ========== SECTION 18: MODULE CHECK SCRIPT ========== -->
    <script>
        // This will show which files are loaded
        setTimeout(() => {
            console.log('‚úÖ Modules Check:');
            console.log('Students:', !!window.StudentManager);
            console.log('Payments:', !!window.PaymentManager);
            console.log('Tienda - Products:', !!window.ProductManager);
            console.log('Tienda - Sales:', !!window.SalesManager);
            console.log('Finance:', !!window.FinanceManager);
            console.log('Groups:', !!window.GroupsManager);
            console.log('Teachers:', !!window.TeacherManager);
            console.log('Admin Center:', !!window.AdminCenter);
        }, 5000);
    </script>

    <!-- ========== SECTION 19: AUTO-LOAD USERS SCRIPT ========== -->
    <script>
        // Auto-load usuarios when config opens
        document.addEventListener('DOMContentLoaded', () => {
            // Define the function
            window.loadUsuariosActuales = function() {
                const container = document.getElementById('usersList');
                if (!container) return;
                
                const db = window.firebaseModules.database;
                const usersRef = db.ref(window.FirebaseData.database, 'users');
                
                db.get(usersRef).then(snapshot => {
                    if (!snapshot.exists()) {
                        container.innerHTML = '<p>No hay usuarios registrados</p>';
                        return;
                    }
                    
                    let html = '';
                    snapshot.forEach(child => {
                        const data = child.val();
                        const email = data.email || data.profile?.email || 'Sin email';
                        const role = data.profile?.role || 'Sin rol';
                        
                        html += `
                            <div style="padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
                                <div style="font-weight: 500;">${email}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Rol: ${role}</div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                }).catch(error => {
                    container.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
                });
            };
            
            // Check periodically for the usersList
            setInterval(() => {
                const container = document.getElementById('usersList');
                if (container && container.textContent.includes('Cargando usuarios')) {
                    loadUsuariosActuales();
                }
            }, 2000);
        });
    </script>

    <!-- Twemoji initialization for emoji fallback -->
    <script>
        // Parse emojis with Twemoji for systems that don't support native emojis (Windows 7, etc.)
        if (typeof twemoji !== 'undefined') {
            // Initial parse
            twemoji.parse(document.body, {
                folder: 'svg',
                ext: '.svg',
                className: 'twemoji'
            });

            // Re-parse when DOM changes (for dynamically loaded content)
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            twemoji.parse(node, {
                                folder: 'svg',
                                ext: '.svg',
                                className: 'twemoji'
                            });
                        }
                    });
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            console.log('‚úÖ Twemoji initialized for emoji fallback');
        }
    </script>

    <style>
        /* Twemoji styling - make emoji images inline and properly sized */
        img.twemoji {
            height: 1.2em;
            width: 1.2em;
            margin: 0 0.05em 0 0.1em;
            vertical-align: -0.15em;
            display: inline-block;
        }
    </style>

</body>
</html>



