// ===== SIMPLE AND SAFE TASK MANAGEMENT SYSTEM =====
// This version is designed to be safe and not break your existing CRM

let tasks = [
    {
        id: '1',
        title: 'Design login page',
        description: 'Create wireframes and mockups for the login page',
        status: 'in-progress',
        priority: 'high',
        assignee: 'John Doe',
        dueDate: '2024-08-14'
    },
    {
        id: '2',
        title: 'Implement API authentication',
        description: 'Set up JWT authentication for the API',
        status: 'in-progress',
        priority: 'urgent',
        assignee: 'Jane Smith',
        dueDate: '2024-08-09'
    }
];

// ===== MAIN LOADING FUNCTION =====
function loadTasksData() {
    console.log('üìã Loading task management...');
    
    // Try to find the correct container
    let container = document.getElementById('tasksContainer');
    if (!container) {
        container = document.getElementById('tasks');
    }
    
    if (!container) {
        console.error('‚ùå No task container found');
        return;
    }
    
    console.log('‚úÖ Found container:', container.id);
    
    // Clear and show container
    container.innerHTML = '';
    container.style.display = 'block';
    container.classList.remove('hidden');
    
    // Add minimal styles
    addSafeStyles();
    
    // Render simple task board
    container.innerHTML = createSimpleTaskBoard();
    
    console.log('‚úÖ Task system loaded successfully');
}

// ===== CREATE SIMPLE TASK BOARD =====
function createSimpleTaskBoard() {
    return `
        <div style="padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #1f2937;">üìã Task Management</h2>
                <button onclick="createNewTask()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    ‚ûï New Task
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- To Do Column -->
                <div style="background: #f8fafc; border-radius: 8px; padding: 15px;">
                    <h3 style="margin: 0 0 15px 0; color: #6b7280; text-align: center;">üìù To Do</h3>
                    <div id="todo-tasks">
                        ${renderTasksForStatus('todo')}
                    </div>
                </div>
                
                <!-- In Progress Column -->
                <div style="background: #eff6ff; border-radius: 8px; padding: 15px;">
                    <h3 style="margin: 0 0 15px 0; color: #3b82f6; text-align: center;">üîÑ In Progress</h3>
                    <div id="in-progress-tasks">
                        ${renderTasksForStatus('in-progress')}
                    </div>
                </div>
                
                <!-- Completed Column -->
                <div style="background: #f0fdf4; border-radius: 8px; padding: 15px;">
                    <h3 style="margin: 0 0 15px 0; color: #10b981; text-align: center;">‚úÖ Completed</h3>
                    <div id="completed-tasks">
                        ${renderTasksForStatus('completed')}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Simple Modal -->
        <div id="taskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%;">
                <h3>Create New Task</h3>
                <input type="text" id="newTaskTitle" placeholder="Task title..." style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                <textarea id="newTaskDesc" placeholder="Description..." style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
                <select id="newTaskPriority" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="low">üü¢ Low Priority</option>
                    <option value="medium" selected>üîµ Medium Priority</option>
                    <option value="high">üü† High Priority</option>
                    <option value="urgent">üî¥ Urgent</option>
                </select>
                <input type="text" id="newTaskAssignee" placeholder="Assignee name..." style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="closeTaskModal()" style="flex: 1; padding: 10px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button onclick="saveNewTask()" style="flex: 1; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Task</button>
                </div>
            </div>
        </div>
    `;
}

// ===== RENDER TASKS FOR SPECIFIC STATUS =====
function renderTasksForStatus(status) {
    const statusTasks = tasks.filter(task => task.status === status);
    
    if (statusTasks.length === 0) {
        return '<div style="text-align: center; color: #9ca3af; padding: 20px; font-style: italic;">No tasks here</div>';
    }
    
    return statusTasks.map(task => `
        <div style="background: white; border: 1px solid #e5e7eb; border-left: 4px solid ${getPriorityColor(task.priority)}; border-radius: 6px; padding: 15px; margin-bottom: 10px; cursor: pointer;" onclick="editTask('${task.id}')">
            <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px;">${task.title}</div>
            <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 8px;">${task.description}</div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                <span style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 12px;">${task.assignee}</span>
                <span style="background: ${getPriorityBg(task.priority)}; color: ${getPriorityTextColor(task.priority)}; padding: 4px 8px; border-radius: 12px;">${task.priority.toUpperCase()}</span>
            </div>
            ${task.dueDate ? `<div style="font-size: 0.8rem; color: #6b7280; margin-top: 8px;">üìÖ ${task.dueDate}</div>` : ''}
        </div>
    `).join('');
}

// ===== TASK MANAGEMENT FUNCTIONS =====
function createNewTask() {
    const modal = document.getElementById('taskModal');
    if (modal) {
        modal.style.display = 'flex';
    }
}

function closeTaskModal() {
    const modal = document.getElementById('taskModal');
    if (modal) {
        modal.style.display = 'none';
        // Clear form
        document.getElementById('newTaskTitle').value = '';
        document.getElementById('newTaskDesc').value = '';
        document.getElementById('newTaskAssignee').value = '';
    }
}

function saveNewTask() {
    const title = document.getElementById('newTaskTitle').value.trim();
    const description = document.getElementById('newTaskDesc').value.trim();
    const priority = document.getElementById('newTaskPriority').value;
    const assignee = document.getElementById('newTaskAssignee').value.trim();
    
    if (!title) {
        alert('Please enter a task title');
        return;
    }
    
    const newTask = {
        id: Date.now().toString(),
        title: title,
        description: description,
        status: 'todo',
        priority: priority,
        assignee: assignee || 'Unassigned',
        dueDate: ''
    };
    
    tasks.push(newTask);
    closeTaskModal();
    loadTasksData(); // Refresh the board
    
    if (window.showNotification) {
        window.showNotification('Task created successfully! üéâ', 'success');
    }
}

function editTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    
    const newStatus = prompt(`Current status: ${task.status}\n\nChoose new status:\n- todo\n- in-progress\n- completed\n- blocked`, task.status);
    
    if (newStatus && ['todo', 'in-progress', 'completed', 'blocked'].includes(newStatus)) {
        task.status = newStatus;
        loadTasksData(); // Refresh the board
        
        if (window.showNotification) {
            window.showNotification(`Task moved to ${newStatus}`, 'success');
        }
    }
}

// ===== UTILITY FUNCTIONS =====
function getPriorityColor(priority) {
    const colors = {
        low: '#10b981',
        medium: '#3b82f6',
        high: '#f59e0b',
        urgent: '#dc2626'
    };
    return colors[priority] || '#3b82f6';
}

function getPriorityBg(priority) {
    const colors = {
        low: '#d1fae5',
        medium: '#dbeafe',
        high: '#fef3c7',
        urgent: '#fee2e2'
    };
    return colors[priority] || '#dbeafe';
}

function getPriorityTextColor(priority) {
    const colors = {
        low: '#059669',
        medium: '#2563eb',
        high: '#d97706',
        urgent: '#dc2626'
    };
    return colors[priority] || '#2563eb';
}

// ===== SAFE CSS STYLES =====
function addSafeStyles() {
    // Only add styles if they don't exist
    if (document.getElementById('safe-task-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'safe-task-styles';
    style.textContent = `
        /* Safe task management styles - won't conflict with existing CSS */
        .task-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .task-card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }
        
        @media (max-width: 768px) {
            .task-grid {
                grid-template-columns: 1fr !important;
            }
        }
    `;
    
    document.head.appendChild(style);
}

// ===== REFRESH FUNCTION =====
function refreshTasks() {
    loadTasksData();
    if (window.showNotification) {
        window.showNotification('Tasks refreshed! üîÑ', 'info');
    }
}

// ===== EXPORT TO GLOBAL SCOPE =====
window.loadTasksData = loadTasksData;
window.createNewTask = createNewTask;
window.closeTaskModal = closeTaskModal;
window.saveNewTask = saveNewTask;
window.editTask = editTask;
window.refreshTasks = refreshTasks;

console.log('‚úÖ SAFE Task Management System loaded!');
